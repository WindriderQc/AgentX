# N6.1 Workflow Architect - Deployment Guide

This guide walks through deploying the N6.1 SBQC Workflow Architect workflow step by step.

## Prerequisites

- n8n instance running and accessible at https://n8n.specialblend.icu
- AgentX running at http://192.168.2.33:3080
- DataAPI running at http://192.168.2.33:3003
- N8N_API_KEY configured in /home/yb/codes/AgentX/.env
- MongoDB running at http://192.168.2.33:27017

## Deployment Steps

### Step 1: Seed the Workflow Architect Persona

The workflow requires a specialized AI persona that knows how to generate n8n workflows.

```bash
cd /home/yb/codes/AgentX
node scripts/seed-workflow-architect-persona.js
```

Expected output:
```
üèóÔ∏è  SBQC Workflow Architect Persona Seeding
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üì° Connecting to MongoDB: mongodb://192.168.2.33:27017/agentx
‚úì Connected to MongoDB

üìã Checking sbqc_workflow_architect persona...
‚úì Created sbqc_workflow_architect persona (version 1)

üìä Current Personas:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úì sbqc_ops (v1)
   SBQC Ops - Infrastructure monitoring and operations agent
‚úì datalake_janitor (v1)
   Datalake Janitor - File management, deduplication, and cleanup agent
‚úì default_chat (v1)
   Default chat assistant persona
‚úì sbqc_workflow_architect (v1)
   SBQC Workflow Architect - Generates n8n workflows from natural language

‚úÖ Seeding complete!
```

### Step 2: Validate the Workflow JSON

Ensure the workflow JSON is valid before deployment:

```bash
jq empty /home/yb/codes/AgentX/AgentC/N6.1.json && echo "‚úì JSON is valid"
```

### Step 3: Deploy to n8n

Deploy the workflow using the deployment script:

```bash
cd /home/yb/codes/AgentX
./scripts/deploy-n8n-workflows.sh N6.1.json
```

Expected output:
```
Deploying workflow: N6.1.json
Workflow "SBQC - N6.1 Workflow Architect" deployed successfully
Workflow ID: abc123def456
```

Save the workflow ID for the next step.

### Step 4: Activate the Workflow

The workflow is deployed in an inactive state. Activate it:

```bash
# Set your workflow ID from step 3
WORKFLOW_ID="abc123def456"

# Source the environment variables
source /home/yb/codes/AgentX/.env

# Activate the workflow
curl -X POST \
  -H "X-N8N-API-KEY: $N8N_API_KEY" \
  "https://n8n.specialblend.icu/api/v1/workflows/$WORKFLOW_ID/activate"
```

Expected response:
```json
{
  "data": {
    "id": "abc123def456",
    "active": true
  }
}
```

### Step 5: Test the Workflow

Test the workflow with a simple request:

```bash
curl -X POST https://n8n.specialblend.icu/webhook/sbqc-workflow-architect \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Create a simple webhook that accepts a message and returns it with a timestamp"
  }'
```

Expected response structure:
```json
{
  "success": true,
  "workflowName": "SBQC - N7.1 Message Echo",
  "workflowId": "xyz789",
  "deployed": true,
  "filePath": "/tmp/n8n-workflows/n7-1-message-echo.json",
  "webhookUrls": [
    "https://n8n.specialblend.icu/webhook/sbqc-message-echo"
  ],
  "stats": {
    "nodeCount": 5,
    "webhookCount": 1
  },
  "generatedWorkflow": { /* complete workflow JSON */ },
  "note": "Workflow deployed in INACTIVE state. Activate it in n8n UI or via API."
}
```

### Step 6: Verify in n8n UI

1. Open https://n8n.specialblend.icu
2. Look for "SBQC - N6.1 Workflow Architect" in the workflows list
3. The workflow should show as "Active"
4. Click to open and inspect the workflow visually

## Post-Deployment Verification

### Check Webhook Registration

Verify the webhook is registered:

```bash
curl -X POST https://n8n.specialblend.icu/webhook/sbqc-workflow-architect \
  -H "Content-Type: application/json" \
  -d '{"description": "test"}'
```

If you get "webhook not registered" error:
- Verify workflow is active in n8n UI
- Check webhook node has `webhookId: "sbqc-n61-workflow-architect"`
- Check webhook node has `httpMethod: "POST"` in parameters
- Redeploy if necessary

### Check AgentX Persona

Verify the persona is available:

```bash
curl -X POST http://192.168.2.33:3080/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Hello, can you help me generate a workflow?",
    "persona": "sbqc_workflow_architect"
  }'
```

Expected: The AI should respond acknowledging its role as a workflow architect.

### Check DataAPI Logging

After a successful workflow generation, verify the event was logged:

```bash
curl http://192.168.2.33:3003/integrations/events/n8n?workflow_id=N6.1 | jq
```

Expected: Recent events with `event_type: "workflow_generation"`

## Troubleshooting

### Error: "Persona not found"

**Problem**: AgentX can't find the sbqc_workflow_architect persona

**Solution**:
```bash
# Re-run the persona seeding script
cd /home/yb/codes/AgentX
node scripts/seed-workflow-architect-persona.js

# Verify the persona exists
mongo mongodb://192.168.2.33:27017/agentx --eval "db.promptconfigs.find({name: 'sbqc_workflow_architect'})"
```

### Error: "The requested webhook is not registered"

**Problem**: Webhook not available

**Solutions**:
1. Verify workflow is active:
   ```bash
   curl -H "X-N8N-API-KEY: $N8N_API_KEY" \
     "https://n8n.specialblend.icu/api/v1/workflows/$WORKFLOW_ID"
   ```

2. Check the webhook node configuration in n8n UI:
   - Must have `webhookId` field
   - Must have `httpMethod: "POST"` in parameters

3. Reactivate the workflow:
   ```bash
   # Deactivate
   curl -X POST -H "X-N8N-API-KEY: $N8N_API_KEY" \
     "https://n8n.specialblend.icu/api/v1/workflows/$WORKFLOW_ID/deactivate"

   # Reactivate
   curl -X POST -H "X-N8N-API-KEY: $N8N_API_KEY" \
     "https://n8n.specialblend.icu/api/v1/workflows/$WORKFLOW_ID/activate"
   ```

### Error: "Missing required field: description"

**Problem**: Request missing the description field

**Solution**: Ensure your request includes the description:
```bash
curl -X POST https://n8n.specialblend.icu/webhook/sbqc-workflow-architect \
  -H "Content-Type: application/json" \
  -d '{"description": "Your workflow description here"}'
```

### Error: "Workflow validation failed"

**Problem**: AI generated invalid workflow JSON

**Response Example**:
```json
{
  "success": false,
  "error": "Workflow validation failed",
  "validationErrors": [
    "Webhook node 0 missing webhookId",
    "Connection source \"Invalid Node\" not found in nodes"
  ]
}
```

**Solutions**:
1. Try with a more detailed description
2. Review the `rawResponse` field to see what the AI generated
3. The validation error will indicate what's wrong
4. Try again with a simpler request first

### Generated workflow has disconnected nodes

**Problem**: Nodes appear disconnected in n8n UI

**Cause**: Connections using node IDs instead of names

**Solution**: This should be caught by validation, but if it happens:
1. Review the generated workflow JSON in the response
2. Check that connections use node names (e.g., "Webhook Trigger") not IDs (e.g., "WebhookTrigger")
3. Manually fix in n8n UI or request regeneration

## Usage Examples

### Example 1: Simple Echo Webhook

```bash
curl -X POST https://n8n.specialblend.icu/webhook/sbqc-workflow-architect \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Create a webhook that accepts JSON data and echoes it back with a timestamp"
  }'
```

### Example 2: AI Query Handler

```bash
curl -X POST https://n8n.specialblend.icu/webhook/sbqc-workflow-architect \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Create a webhook that accepts a user question in a message field, sends it to AgentX with the default_chat persona, and returns the AI response. Include validation for the message field and proper error handling."
  }'
```

### Example 3: Scheduled Health Check

```bash
curl -X POST https://n8n.specialblend.icu/webhook/sbqc-workflow-architect \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Create a scheduled workflow that runs every 30 minutes, calls DataAPI system health endpoint, checks if MongoDB and both Ollama hosts are up, and logs the results to DataAPI. Include error handling for failed health checks."
  }'
```

### Example 4: Multi-API Orchestration

```bash
curl -X POST https://n8n.specialblend.icu/webhook/sbqc-workflow-architect \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Create a webhook that calls both Ollama hosts (192.168.2.99:11434 and 192.168.2.12:11434) in parallel to check available models, merges the results, formats them into a combined report, and returns the report. Include timeout handling and DataAPI logging."
  }'
```

## Next Steps

After successful deployment:

1. **Test with simple workflows** first to verify functionality
2. **Review generated workflows** in n8n UI to understand output
3. **Iterate on prompts** to improve generation quality
4. **Monitor DataAPI logs** for generation events
5. **Update the persona** if needed to improve instructions
6. **Share examples** of successful generations for documentation

## Maintenance

### Updating the Persona

To improve the workflow architect's behavior:

1. Edit `/home/yb/codes/AgentX/scripts/seed-workflow-architect-persona.js`
2. Update the `systemPrompt` field
3. Run the seed script:
   ```bash
   node scripts/seed-workflow-architect-persona.js
   ```
4. Test with new generation requests

### Redeploying the Workflow

If you modify N6.1.json:

1. Validate JSON: `jq empty N6.1.json`
2. Deploy: `./scripts/deploy-n8n-workflows.sh N6.1.json`
3. Get new workflow ID from output
4. Activate the new deployment
5. Deactivate old deployment if needed

## Support

For issues or questions:

1. Check this deployment guide
2. Review N6.1-README.md for detailed documentation
3. Check n8n execution history for errors
4. Review AgentX logs for persona issues
5. Verify DataAPI logging for events
6. Test with simpler workflow descriptions

## Version

- Workflow Version: 1.0.0
- Persona Version: 1.0.0
- Last Updated: 2026-01-02

# N6.1 - SBQC Workflow Architect

**Status**: ðŸ“‹ Ready for Deployment
**Priority**: 6
**Webhook**: `sbqc-workflow-architect`
**Method**: POST

## Overview

The SBQC Workflow Architect is an AI-powered workflow generation system that creates complete, valid n8n workflow JSON definitions from natural language descriptions. It uses AgentX with a specialized "sbqc_workflow_architect" persona to understand requirements and generate production-ready workflows that follow SBQC conventions.

## Architecture

```
User Request (Natural Language)
    â†“
Webhook Trigger (POST)
    â†“
Validate Request â†’ Check for 'description' field
    â†“
Prepare Context & Prompt â†’ Load templates, conventions, examples
    â†“
Call AgentX â†’ Use 'sbqc_workflow_architect' persona
    â†“
Parse & Validate Response â†’ Check structure, connections, webhooks
    â†“
Save Workflow File â†’ Write to /tmp/n8n-workflows/
    â†“
Deploy to n8n â†’ POST to n8n API
    â†“
Format Response â†’ Return deployment details
    â†“
Log to DataAPI â†’ Record generation event
```

## Workflow Nodes

### 1. Webhook Trigger
- **Path**: `/webhook/sbqc-workflow-architect`
- **Method**: POST
- **Body**: `{ "description": "string", "autoActivate": boolean }`

### 2. Validate Request
- Checks for required `description` field
- Returns error if missing

### 3. Check Validation
- IF node that routes to error handler or continues

### 4. Prepare Context & Prompt
- Loads workflow templates (webhook_basic, ai_query, scheduled_task, etc.)
- Embeds SBQC naming conventions
- Includes validation requirements
- Provides example workflow structure
- Builds comprehensive prompt for AgentX

### 5. Call AgentX (Workflow Architect)
- **Endpoint**: http://192.168.2.33:3080/api/chat
- **Persona**: sbqc_workflow_architect
- **Timeout**: 120 seconds
- **Model**: qwen2.5:7b-instruct-q4_0

### 6. Parse & Validate Response
- Extracts JSON from AI response
- Removes markdown code blocks if present
- Validates structure:
  - Has `name` field
  - Has `nodes` array
  - Has `connections` object
  - Webhook nodes have `webhookId` and `httpMethod`
  - Connection references exist in nodes array

### 7. Is Valid?
- IF node checking validation result
- Routes to deployment or error formatting

### 8. Save Workflow File
- Creates `/tmp/n8n-workflows/` if needed
- Generates filename from workflow name
- Writes JSON to file system

### 9. Deploy to n8n
- **Endpoint**: https://n8n.specialblend.icu/api/v1/workflows
- **Method**: POST
- **Auth**: X-N8N-API-KEY header
- Workflow deployed in INACTIVE state

### 10. Format Success Response
- Returns deployment details:
  - Workflow name and ID
  - Webhook URLs (if applicable)
  - File path
  - Node statistics
  - Deployment logs
  - Generated workflow JSON

### 11. Format Validation Error
- Returns validation errors
- Includes raw AI response
- Includes partially parsed workflow (if any)

### 12. Format Request Error
- Returns 400 error for missing fields

### 13. Merge All Responses
- Combines success/error paths

### 14. Respond to Webhook
- Returns JSON response to caller

### 15. Log to DataAPI
- Records generation event
- Includes success status, workflow details, errors
- **continueOnFail**: true

## Request Format

```json
{
  "description": "Create a webhook that accepts a user query, calls AgentX for processing, and returns the AI response",
  "autoActivate": true
}
```

### Fields

- **description** (required): Natural language description of the workflow
- **autoActivate** (optional): Whether to activate after deployment (default: true, but currently manual activation required)

## Response Format

### Success Response

```json
{
  "success": true,
  "workflowName": "SBQC - N7.1 User Query Handler",
  "workflowId": "abc123",
  "deployed": true,
  "statusCode": 201,
  "filePath": "/tmp/n8n-workflows/n7-1-user-query-handler.json",
  "webhookUrls": [
    "https://n8n.specialblend.icu/webhook/sbqc-user-query"
  ],
  "autoActivate": true,
  "stats": {
    "nodeCount": 8,
    "webhookCount": 1
  },
  "deploymentLog": {
    "timestamp": "2026-01-02T12:00:00.000Z",
    "method": "POST",
    "endpoint": "https://n8n.specialblend.icu/api/v1/workflows",
    "response": { /* n8n API response */ }
  },
  "generatedWorkflow": { /* complete workflow JSON */ },
  "note": "Workflow deployed in INACTIVE state. Activate it in n8n UI or via API."
}
```

### Validation Error Response

```json
{
  "success": false,
  "error": "Workflow validation failed",
  "validationErrors": [
    "Webhook node 0 missing webhookId",
    "Connection source \"Invalid Node\" not found in nodes"
  ],
  "rawResponse": "...",
  "parsedWorkflow": { /* partial workflow */ },
  "timestamp": "2026-01-02T12:00:00.000Z"
}
```

### Request Error Response

```json
{
  "success": false,
  "error": "Missing required field: description",
  "status": 400,
  "timestamp": "2026-01-02T12:00:00.000Z"
}
```

## Setup Requirements

### 1. Deploy the Persona

Before using the workflow, you must seed the `sbqc_workflow_architect` persona:

```bash
cd /home/yb/codes/AgentX
node scripts/seed-workflow-architect-persona.js
```

This creates the specialized AI persona that knows how to generate n8n workflows.

### 2. Deploy the Workflow

```bash
cd /home/yb/codes/AgentX
./scripts/deploy-n8n-workflows.sh N6.1.json
```

### 3. Activate the Workflow

The workflow is deployed in inactive state. Activate it:

```bash
# Get the workflow ID from deployment output
WORKFLOW_ID="<id-from-deployment>"

# Activate it
curl -X POST \
  -H "X-N8N-API-KEY: $N8N_API_KEY" \
  "https://n8n.specialblend.icu/api/v1/workflows/$WORKFLOW_ID/activate"
```

## Usage Examples

### Example 1: Simple Webhook Echo

```bash
curl -X POST https://n8n.specialblend.icu/webhook/sbqc-workflow-architect \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Create a simple webhook that echoes back whatever JSON is sent to it"
  }'
```

### Example 2: AI Query Handler

```bash
curl -X POST https://n8n.specialblend.icu/webhook/sbqc-workflow-architect \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Create a webhook that accepts a user message, sends it to AgentX for processing with the default_chat persona, and returns the AI response. Include error handling and DataAPI logging."
  }'
```

### Example 3: Scheduled Data Aggregation

```bash
curl -X POST https://n8n.specialblend.icu/webhook/sbqc-workflow-architect \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Create a workflow that runs every hour, fetches system health from DataAPI, analyzes it with AgentX using the sbqc_ops persona, and logs the results. Include error handling."
  }'
```

### Example 4: Multi-API Orchestration

```bash
curl -X POST https://n8n.specialblend.icu/webhook/sbqc-workflow-architect \
  -H "Content-Type: application/json" \
  -d '{
    "description": "Create a webhook that calls both Ollama hosts in parallel to check model availability, merges the results, and returns a combined status report. Include timeout handling and DataAPI logging."
  }'
```

## Embedded Workflow Templates

The workflow includes these templates for reference:

1. **webhook_basic**: Basic webhook with validation and response
2. **ai_query**: Webhook that calls AgentX for AI processing
3. **scheduled_task**: Cron-based scheduled workflow
4. **api_orchestration**: Multiple parallel API calls with aggregation

## SBQC Conventions Enforced

The generated workflows follow these conventions:

- **Naming**: `SBQC - N#.# Description`
- **WebhookIds**: `sbqc-n##-description` (lowercase, no spaces)
- **HTTP Method**: Always specified in webhook parameters
- **Response Mode**: Appropriate for use case (responseNode or onReceived)
- **Connections**: Use node names, not IDs
- **Error Handling**: continueOnFail on appropriate nodes
- **Logging**: DataAPI integration at the end
- **Tags**: Include SBQC, Priority, and feature tags

## Validation Checks

The workflow validates:

1. **Structure**: name, nodes, connections present
2. **Webhooks**: Have webhookId and httpMethod
3. **Connections**: Source and target nodes exist
4. **Node Names**: No duplicate names
5. **JSON Syntax**: Valid parseable JSON

## Post-Deployment Steps

After the workflow generates and deploys a new workflow:

1. **Check the response** for the new workflow ID
2. **Review the generated JSON** in the response
3. **Open n8n UI** to inspect the workflow visually
4. **Activate the workflow** (via UI or API)
5. **Test the workflow** using the provided webhook URL
6. **Monitor execution** in n8n execution history

## Troubleshooting

### Issue: "Persona not found"

**Solution**: Run the persona seed script:
```bash
node scripts/seed-workflow-architect-persona.js
```

### Issue: Generated workflow has disconnected nodes

**Cause**: AI used node IDs instead of names in connections

**Solution**: The validation step should catch this. If not, manually fix the connections in n8n UI or regenerate with more specific prompt.

### Issue: Workflow won't activate

**Cause**: Webhook already registered or validation errors

**Solution**: Check n8n logs, verify webhookId is unique, check for errors in n8n UI.

### Issue: AI returns markdown-wrapped JSON

**Solution**: The parse step handles this automatically by stripping ```json blocks.

### Issue: Generated workflow missing error handling

**Solution**: Be specific in the description: "Include error handling with IF nodes and error formatting"

## Development Notes

### Improving the Architect Persona

To update the persona with better instructions:

1. Edit `/home/yb/codes/AgentX/scripts/seed-workflow-architect-persona.js`
2. Update the `systemPrompt` field
3. Run: `node scripts/seed-workflow-architect-persona.js`
4. Test with new workflow generation requests

### Adding More Templates

Edit the `PrepareContext` node (ID: `PrepareContext`) and add more templates to the `workflowTemplates` object.

### Enhancing Validation

Edit the `ParseValidate` node (ID: `ParseValidate`) to add more validation checks.

## Integration Points

- **AgentX**: http://192.168.2.33:3080/api/chat
- **n8n API**: https://n8n.specialblend.icu/api/v1/workflows
- **DataAPI**: http://192.168.2.33:3003/integrations/events/n8n

## Security Notes

- Uses existing n8n API credentials (Header Auth)
- No user authentication on webhook (add if needed)
- Generated workflows deployed in INACTIVE state (safe)
- File system access limited to /tmp/n8n-workflows/
- AgentX persona isolated to workflow generation task

## Future Enhancements

Potential improvements:

1. **Workflow Editing**: Accept workflow ID + description to modify existing workflows
2. **Template Library**: Load templates from DataAPI or file system
3. **Version Control**: Git integration for generated workflows
4. **Approval Gate**: Human review before deployment
5. **Auto-Activation**: Implement the autoActivate flag
6. **Testing**: Generate test cases for workflows
7. **Documentation**: Auto-generate README for workflows
8. **Visual Preview**: Return workflow canvas image
9. **Rollback**: Save previous versions before updates
10. **Sharing**: Export workflows for other n8n instances

## Related Workflows

- **N3.2**: External AI Gateway (template for AI integration)
- **N5.1**: Feedback Analysis (template for scheduled tasks)
- **N0.0**: Test Deployment (example workflow structure)

## Version History

- **v1.0.0** (2026-01-02): Initial implementation
  - Natural language to workflow JSON
  - Comprehensive validation
  - n8n deployment integration
  - DataAPI logging
  - Error handling for all paths

## Support

For issues or questions:
1. Check validation errors in response
2. Review generated JSON for syntax issues
3. Check AgentX logs for persona issues
4. Verify n8n API connectivity
5. Test manually with simpler descriptions

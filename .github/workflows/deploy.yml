name: ğŸš€ Deploy AgentX

on:
  push:
    branches:
      - main

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ§ª Run Tests
        run: npm test
        
      - name: âœ… Tests Passed
        run: echo "âœ… All tests passed! Ready to deploy."

  deploy-local:
    name: ğŸ  Deploy Local (AgentX)
    needs: test
    runs-on: self-hosted
    if: ${{ github.event_name == 'push' }}
    environment:
      name: production
      url: http://192.168.2.33:3080
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”„ Update & Restart
        run: |
          TARGET_DIR="${{ secrets.AGENTX_DEPLOY_PATH }}"
          TARGET_DIR="${TARGET_DIR:-/home/yb/codes/AgentX}"
          
          echo "ğŸ“‚ Deploying to: $TARGET_DIR"
          
          if [ -d "$TARGET_DIR" ]; then
            cd "$TARGET_DIR"
            
            # Backup current state
            git stash
            
            # Update code
            git fetch origin
            git reset --hard origin/main
            
            # Clean install
            rm -rf node_modules package-lock.json
            npm ci
            
            # Check if PM2 process exists
            if pm2 describe agentx > /dev/null 2>&1; then
              # Zero-downtime reload
              pm2 reload agentx
              echo "ğŸ”„ PM2 reload complete"
            else
              # First time deployment
              pm2 start server.js --name agentx
              pm2 save
              echo "ğŸ†• PM2 started agentx"
            fi
            
            echo "ğŸ‰ AgentX Deployment complete!"
          else
            echo "âŒ Target directory $TARGET_DIR not found on runner!"
            exit 1
          fi

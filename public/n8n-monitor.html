<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n8n Workflow Monitor • AgentX</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="top-nav">
        <a href="index.html"><i class="fas fa-comments"></i> Chat</a>
        <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Operations</a>
        <a href="n8n-monitor.html" class="active"><i class="fas fa-network-wired"></i> n8n Monitor</a>
        <a href="analytics.html"><i class="fas fa-chart-line"></i> Analytics</a>
    </nav>
    <div class="monitor-page">
        <div class="monitor-header">
            <div class="eyebrow">AgentX • Operations</div>
            <h1><i class="fas fa-network-wired"></i><span class="title-separator"></span>n8n Workflow Monitor</h1>
            <p class="lede">Test and monitor SBQC n8n workflows. Trigger webhooks, view execution history, and monitor real-time events.</p>
        </div>
        
        <div class="monitor-grid">
            <div class="workflow-list">
                <h2>Workflows</h2>
                
                <div class="deploy-section">
                    <h3><i class="fas fa-upload"></i> Deploy to n8n</h3>
                    <div class="deploy-controls">
                        <button class="deploy-btn" onclick="deployWorkflows(false)">
                            <i class="fas fa-upload"></i> Deploy Selected
                        </button>
                        <button class="deploy-btn" onclick="deployWorkflows(true)">
                            <i class="fas fa-sync"></i> Deploy All
                        </button>
                    </div>
                    <div id="deploy-log" class="deploy-log"></div>
                </div>
                
                <div id="workflow-container">
                    <!-- Populated dynamically -->
                    <div class="loading">
                        <i class="fas fa-spinner"></i> Loading workflows...
                    </div>
                </div>
            </div>
            
            <div class="workflow-details">
                <div id="detail-container">
                    <div class="empty-state">
                        <i class="fas fa-hand-pointer"></i>
                        <p>Select a workflow to view details and test controls</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message"></span>
    </div>
    
    <script>
        const WORKFLOWS = [
            { id: 'N1.1', name: 'System Health Monitor', webhook: 'sbqc-n1-1-system-health', type: 'GET' },
            { id: 'N1.3', name: 'Ops Diagnostic', webhook: 'sbqc-n1-3-ops-diagnostic', type: 'GET' },
            { id: 'N2.1', name: 'NAS Scan', webhook: 'sbqc-n2-1-nas-scan', type: 'POST' },
            { id: 'N2.2', name: 'NAS Full Scan', webhook: 'sbqc-n2-2-nas-full-scan', type: 'POST' },
            { id: 'N2.3', name: 'RAG Ingest', webhook: 'sbqc-n2-3-rag-ingest', type: 'POST' },
            { id: 'N3.1', name: 'Model Health & Latency Monitor', webhook: 'sbqc-n3-1-model-monitor', type: 'GET' },
            { id: 'N3.2', name: 'External AI Trigger Gateway', webhook: 'sbqc-ai-query', type: 'POST' },
            { id: 'N5.1', name: 'Feedback Analysis', webhook: 'sbqc-n5-1-feedback-analysis', type: 'POST' }
        ];
        
        const N8N_BASE = 'https://n8n.specialblend.icu';
        const DATAAPI_BASE = 'http://192.168.2.33:3003';
        const AGENTX_BASE = 'http://192.168.2.33:3080';
        
        let currentWorkflow = null;
        let events = [];
        let eventRefreshInterval = null;
        
        async function deployWorkflows(deployAll) {
            const btn = event.target;
            const logEl = document.getElementById('deploy-log');
            
            btn.disabled = true;
            logEl.classList.add('show');
            logEl.textContent = deployAll ? 'Deploying all workflows...\n' : 'Deploying selected workflow...\n';
            
            try {
                const payload = {};
                if (!deployAll && currentWorkflow) {
                    payload.workflows = [currentWorkflow.id];
                }
                
                const response = await fetch(`${AGENTX_BASE}/api/n8n/deploy`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': localStorage.getItem('apiKey') || ''
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    logEl.textContent += result.output || 'Deployment completed successfully!\n';
                    showToast('Deployment successful!');
                } else {
                    logEl.textContent += `ERROR: ${result.message}\n${result.stderr || ''}`;
                    showToast('Deployment failed', 'error');
                }
                
            } catch (err) {
                logEl.textContent += `ERROR: ${err.message}`;
                showToast('Deployment failed', 'error');
            } finally {
                btn.disabled = false;
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            msgEl.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function formatTimestamp(ts) {
            const d = new Date(ts);
            return d.toLocaleString('en-CA', { hour12: false }).replace(',', '');
        }
        
        function renderWorkflowList() {
            const container = document.getElementById('workflow-container');
            container.innerHTML = WORKFLOWS.map(wf => `
                <div class="workflow-item ${currentWorkflow?.id === wf.id ? 'active' : ''}" 
                     onclick="selectWorkflow('${wf.id}')">
                    <div class="wf-info">
                        <span class="wf-id">${wf.id}</span>
                        <span class="wf-name">${wf.name}</span>
                    </div>
                    <span class="wf-status active">${wf.type}</span>
                </div>
            `).join('');
        }
        
        function selectWorkflow(id) {
            currentWorkflow = WORKFLOWS.find(wf => wf.id === id);
            renderWorkflowList();
            renderWorkflowDetails();
            loadEvents();
            
            // Start event refresh
            if (eventRefreshInterval) clearInterval(eventRefreshInterval);
            eventRefreshInterval = setInterval(loadEvents, 10000);
        }
        
        function renderWorkflowDetails() {
            if (!currentWorkflow) return;
            
            const webhookUrl = `${N8N_BASE}/webhook/${currentWorkflow.webhook}`;
            
            document.getElementById('detail-container').innerHTML = `
                <div class="detail-header">
                    <div>
                        <h2>${currentWorkflow.name}</h2>
                        <div class="wf-meta">${currentWorkflow.id} • ${currentWorkflow.type} webhook</div>
                    </div>
                    <div class="detail-actions">
                        <button class="btn btn-secondary" onclick="openN8nEditor()">
                            <i class="fas fa-external-link-alt"></i> Open in n8n
                        </button>
                    </div>
                </div>
                
                <div class="detail-tabs">
                    <button class="tab active" onclick="switchTab('test')">Test</button>
                    <button class="tab" onclick="switchTab('events')">Event History</button>
                </div>
                
                <div id="tab-test" class="tab-content active">
                    <div class="webhook-url">${webhookUrl}</div>
                    
                    <div class="test-form">
                        ${currentWorkflow.type === 'POST' ? `
                            <div class="form-group">
                                <label>Request Body (JSON)</label>
                                <textarea id="test-payload">{
  "test": true,
  "source": "agentx-monitor"
}</textarea>
                            </div>
                        ` : ''}
                        
                        <button class="btn btn-primary" onclick="triggerWorkflow()">
                            <i class="fas fa-play"></i> Trigger Workflow
                        </button>
                    </div>
                    
                    <div id="test-result"></div>
                </div>
                
                <div id="tab-events" class="tab-content">
                    <div class="event-log">
                        <h3>Recent Events</h3>
                        <div id="event-list">
                            <div class="loading">
                                <i class="fas fa-spinner"></i> Loading events...
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            if (tab === 'events') {
                loadEvents();
            }
        }
        
        async function triggerWorkflow() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Triggering...';
            
            try {
                const url = `${N8N_BASE}/webhook/${currentWorkflow.webhook}`;
                const options = {
                    method: currentWorkflow.type,
                };
                
                if (currentWorkflow.type === 'POST') {
                    const payload = document.getElementById('test-payload').value;
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = payload;
                }
                
                const response = await fetch(url, options);
                const result = await response.text();
                
                document.getElementById('test-result').innerHTML = `
                    <div class="event-log" style="margin-top: 16px;">
                        <h3>Response</h3>
                        <div class="event-item">
                            <div class="event-header">
                                <span class="status-badge ${response.ok ? 'success' : 'error'}">
                                    <i class="fas fa-${response.ok ? 'check' : 'times'}-circle"></i>
                                    ${response.status} ${response.statusText}
                                </span>
                                <span class="event-timestamp">${formatTimestamp(new Date())}</span>
                            </div>
                            <div class="event-data">${result}</div>
                        </div>
                    </div>
                `;
                
                showToast('Workflow triggered successfully!');
                setTimeout(loadEvents, 2000);
                
            } catch (err) {
                document.getElementById('test-result').innerHTML = `
                    <div class="event-log" style="margin-top: 16px;">
                        <h3>Error</h3>
                        <div class="event-item">
                            <div class="event-header">
                                <span class="status-badge error">
                                    <i class="fas fa-times-circle"></i> Failed
                                </span>
                            </div>
                            <div class="event-data">${err.message}</div>
                        </div>
                    </div>
                `;
                showToast('Failed to trigger workflow', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Trigger Workflow';
            }
        }
        
        async function loadEvents() {
            if (!currentWorkflow) return;
            
            try {
                const response = await fetch(`${DATAAPI_BASE}/api/v1/integrations/events/n8n?limit=50`, { credentials: 'include' });
                if (response.status === 401) {
                    showToast('Please log in to DataAPI to view events', 'error');
                    return;
                }
                const allEvents = await response.json();
                
                // Filter events for current workflow
                events = allEvents.filter(e => 
                    e.body.workflow_id && 
                    e.body.workflow_id.toLowerCase().includes(currentWorkflow.id.toLowerCase())
                );
                
                renderEvents();
            } catch (err) {
                console.error('Failed to load events:', err);
            }
        }
        
        function renderEvents() {
            const container = document.getElementById('event-list');
            if (!container) return;
            
            if (events.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No events yet</p></div>';
                return;
            }
            
            container.innerHTML = events.slice(0, 20).map((evt, index) => {
                const eventType = evt.body.event_type || 'event';
                const timestamp = formatTimestamp(evt.at);
                const fullData = JSON.stringify(evt.body, null, 2);
                const summary = JSON.stringify(evt.body).substring(0, 80) + (JSON.stringify(evt.body).length > 80 ? '...' : '');
                
                return `
                    <div class="event-item" onclick="toggleEventDetails(${index})">
                        <div class="event-header">
                            <div class="event-meta">
                                <span class="event-type">${eventType}</span>
                                <span class="event-timestamp">${timestamp}</span>
                            </div>
                        </div>
                        <div class="event-summary">${summary}</div>
                        <div class="event-details" id="event-details-${index}">
                            <pre>${fullData}</pre>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleEventDetails(index) {
            const el = document.getElementById(`event-details-${index}`);
            if (el) el.classList.toggle('show');
        }
        
        function openN8nEditor() {
            window.open('https://n8n.specialblend.icu', '_blank');
        }
        
        // Initialize
        renderWorkflowList();
    </script>
</body>
</html>

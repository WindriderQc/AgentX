<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentX • AI Control</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="bg-grid"></div>
  <div class="page control-page">
    <header class="hero">
      <div class="hero-content">
        <div class="hero-top">
          <div>
            <div class="eyebrow">AgentX • Orchestration</div>
            <h1>AI Control Board</h1>
            <p class="lede">Advanced control surface for AI operations.</p>
          </div>
          <div class="hero-actions">
              <div style="display: flex; flex-direction: column; align-items: flex-end;">
                <nav class="agentx-nav"></nav>
                <div style="margin-top: 10px; font-size: 12px;">
                    <span class="status-indicator" id="statusIndicator" style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444; display: inline-block;"></span>
                    <span id="statusText" style="color: var(--muted); margin-left: 6px;">Initializing...</span>
                </div>
              </div>
          </div>
        </div>
      </div>
    </header>

    <main class="layout control-layout">
        <!-- Chat Column -->
        <section class="panel chat-panel">
            <div class="panel-head">
                <h2><i class="fas fa-comments me-2"></i> AI Assistant Chat</h2>
            </div>

            <div class="chat-container">
                <div class="chat-window" id="chatMessages" style="height: 500px;">
                    <div class="bubble assistant">
                        <div class="meta">AgentX</div>
                        <p>Hello! I'm your AgentX AI assistant. How can I help you today?</p>
                    </div>
                </div>

                <div class="composer">
                    <div class="quick-actions">
                        <button class="chip" onclick="sendQuickMessage('Check system status')">System Status</button>
                        <button class="chip" onclick="sendQuickMessage('Show RAG collections')">RAG Status</button>
                        <button class="chip" onclick="sendQuickMessage('List Ollama models')">Models</button>
                        <button class="chip" onclick="sendQuickMessage('What can you help me with?')">Help</button>
                    </div>
                    <textarea id="chatInput" rows="2" placeholder="Type your message..." onkeypress="handleKeyPress(event)"></textarea>
                    <div class="composer-actions">
                        <div class="flex-spacer"></div>
                        <button class="primary" onclick="sendMessage()" id="sendBtn">Send</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sidebar Column -->
        <aside class="sidebar-column">
            <!-- Configuration -->
            <div class="panel config-panel">
                <div class="panel-head">
                    <h2><i class="fas fa-cog me-2"></i> Configuration</h2>
                </div>

                <div class="field">
                    <label>AI Source</label>
                    <select id="webhookSelector" onchange="handleWebhookChange()">
                        <option value="ollama">Direct Ollama</option>
                        <option value="n8n-default">n8n Default Agent</option>
                        <option value="custom">Custom n8n Webhook...</option>
                    </select>
                </div>

                <div id="customWebhookDiv" class="field" style="display: none;">
                    <input type="text" id="customWebhookId" placeholder="Enter n8n Webhook ID">
                    <div class="hint">Enter the UUID from n8n Webhook node</div>
                </div>

                <div id="ollamaModelDiv" class="field">
                    <label>Ollama Model</label>
                    <div class="input-row">
                        <select id="ollamaModelSelector">
                            <option value="" disabled selected>Loading models...</option>
                        </select>
                        <button class="icon-btn" onclick="loadOllamaModels(true)">↻</button>
                    </div>
                </div>

                <div class="action-row">
                    <button class="ghost full" onclick="clearChat()">Clear Chat</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="panel stats-panel">
                 <div class="panel-head">
                    <h2>Session Stats</h2>
                </div>
                <div class="stat-row">
                    <span>Messages Sent</span>
                    <strong id="messageCount">0</strong>
                </div>
                <div class="stat-row">
                    <span>AI Responses</span>
                    <strong id="responseCount">1</strong>
                </div>
                <div class="stat-row">
                    <span>Session Time</span>
                    <strong id="sessionTime">Just now</strong>
                </div>
            </div>
        </aside>
    </main>
  </div>

  <style>
      .control-layout {
          display: grid;
          grid-template-columns: 1fr 320px;
          gap: 20px;
      }
      .sidebar-column {
          display: flex;
          flex-direction: column;
          gap: 20px;
      }
      .stat-row {
          display: flex;
          justify-content: space-between;
          padding: 8px 0;
          border-bottom: 1px solid var(--panel-border);
          color: var(--muted);
          font-size: 14px;
      }
      .stat-row strong { color: var(--text); }

      @media (max-width: 900px) {
          .control-layout { grid-template-columns: 1fr; }
      }
  </style>

  <script type="module">
    import { injectNav } from '/js/components/nav.js';
    injectNav('ai-control');
  </script>

  <!-- Re-using logic from original ai-control but adapted to vanilla JS modules/style -->
  <script>
      // Simplified inline script to match original functionality but using new styles
      let messageCount = 0;
      let responseCount = 1;
      const sessionStart = new Date();
      const ollamaModelCache = [];

      // Check system status on load
      checkSystemStatus();

      // Update session time
      setInterval(() => {
          const elapsed = Math.floor((new Date() - sessionStart) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          document.getElementById('sessionTime').textContent = 
              minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
      }, 1000);

      async function checkSystemStatus() {
          try {
              const res = await fetch('/health');
              const health = await res.json();
              const indicator = document.getElementById('statusIndicator');
              const statusText = document.getElementById('statusText');
              
              if (health.status === 'ok') {
                  indicator.style.background = '#10b981';
                  indicator.style.boxShadow = '0 0 8px rgba(16, 185, 129, 0.5)';
                  statusText.textContent = 'System Healthy';
              } else {
                  indicator.style.background = '#ef4444';
                  statusText.textContent = 'System Degraded';
              }
          } catch (e) {
              document.getElementById('statusIndicator').style.background = '#ef4444';
              document.getElementById('statusText').textContent = 'Connection Error';
          }
          
          loadOllamaModels();
      }

      window.handleKeyPress = function(event) {
          if (event.key === 'Enter' && !event.shiftKey) {
              event.preventDefault();
              sendMessage();
          }
      }

      window.sendQuickMessage = function(message) {
          document.getElementById('chatInput').value = message;
          sendMessage();
      }

      window.handleWebhookChange = function() {
          const selector = document.getElementById('webhookSelector');
          const customDiv = document.getElementById('customWebhookDiv');
          const ollamaDiv = document.getElementById('ollamaModelDiv');

          customDiv.style.display = selector.value === 'custom' ? 'block' : 'none';
          ollamaDiv.style.display = selector.value === 'ollama' ? 'block' : 'none';
      }

      window.loadOllamaModels = async function(forceRefresh = false) {
          const select = document.getElementById('ollamaModelSelector');

          if (!forceRefresh && ollamaModelCache.length > 0) {
              populateOllamaModelOptions(select, ollamaModelCache);
              return;
          }

          select.innerHTML = '<option disabled selected>Loading...</option>';

          try {
              const res = await fetch('/api/ollama/models');
              const result = await res.json();

              if (result.status === 'success' && result.data) {
                  ollamaModelCache.length = 0;
                  ollamaModelCache.push(...result.data);
                  populateOllamaModelOptions(select, result.data);
              } else {
                  select.innerHTML = '<option disabled selected>Error loading models</option>';
              }
          } catch (e) {
              console.error(e);
              select.innerHTML = '<option disabled selected>Connection failed</option>';
          }
      }

      function populateOllamaModelOptions(select, models) {
          select.innerHTML = '';
          if (!models || models.length === 0) {
              select.innerHTML = '<option disabled selected>No models found</option>';
              return;
          }

          models.forEach(model => {
              const opt = document.createElement('option');
              opt.value = model.name;
              opt.text = model.name;
              select.appendChild(opt);
          });
      }

      window.sendMessage = async function() {
          const input = document.getElementById('chatInput');
          const message = input.value.trim();
          
          if (!message) return;
          
          addMessage(message, 'user');
          input.value = '';
          
          messageCount++;
          document.getElementById('messageCount').textContent = messageCount;
          
          const typingIndicator = addTypingIndicator();
          
          try {
              const selector = document.getElementById('webhookSelector');
              let response;

              if (selector.value === 'ollama') {
                  const model = document.getElementById('ollamaModelSelector').value;
                  if (!model) throw new Error('Select an Ollama model before chatting');
                  
                  response = await fetch('/api/chat', { // Use standard chat endpoint
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ message: message, model })
                  });
              } else {
                 // Simplified fallback for n8n
                 throw new Error("n8n direct mode not fully ported in this view yet.");
              }
              
              const result = await response.json();
              typingIndicator.remove();
              
              if (response.ok) {
                  const aiResponse = result.data?.response || result.data?.message || 'No response content';
                  addMessage(aiResponse, 'assistant');
                  responseCount++;
                  document.getElementById('responseCount').textContent = responseCount;
              } else {
                  addMessage(`❌ Error: ${result.message || 'Failed to get response'}`, 'assistant');
              }
          } catch (error) {
              typingIndicator.remove();
              addMessage(`❌ Network error: ${error.message}`, 'assistant');
          }
      }

      function addMessage(text, role) {
          const messagesContainer = document.getElementById('chatMessages');
          const bubble = document.createElement('div');
          bubble.className = `bubble ${role}`;
          
          let content = text;
          if (role === 'assistant') {
              bubble.innerHTML = `<div class="meta">AgentX</div><p>${escapeHtml(content)}</p>`;
          } else {
              bubble.innerHTML = `<div class="meta">You</div><p>${escapeHtml(content)}</p>`;
          }
          
          messagesContainer.appendChild(bubble);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function addTypingIndicator() {
          const messagesContainer = document.getElementById('chatMessages');
          const bubble = document.createElement('div');
          bubble.className = 'bubble assistant';
          bubble.innerHTML = `<div class="meta">AgentX</div><p>Thinking...</p>`;
          messagesContainer.appendChild(bubble);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          return bubble;
      }

      function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML.replace(/\n/g, '<br>');
      }

      window.clearChat = function() {
          document.getElementById('chatMessages').innerHTML = `
              <div class="bubble assistant">
                  <div class="meta">AgentX</div>
                  <p>Chat cleared. How can I help you?</p>
              </div>
          `;
          messageCount = 0;
          responseCount = 1;
      }
  </script>
</body>
</html>

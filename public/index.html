<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentX â€¢ Ollama Control</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* Modal Overlay (for Chat Onboarding Wizard) */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* Alert Styles */
    .alert {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      margin: 12px 16px;
      border-radius: 8px;
      background: rgba(124, 240, 255, 0.1);
      border: 1px solid rgba(124, 240, 255, 0.3);
      backdrop-filter: blur(10px);
      animation: slideDown 0.3s ease;
    }

    .alert-info {
      background: rgba(124, 240, 255, 0.1);
      border-color: rgba(124, 240, 255, 0.3);
      color: var(--accent);
    }

    .alert i.fa-info-circle {
      font-size: 20px;
      flex-shrink: 0;
    }

    .alert-content {
      flex: 1;
    }

    .alert-content p {
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }

    .alert-content a {
      color: var(--accent);
      text-decoration: underline;
      font-weight: 600;
    }

    .alert-content a:hover {
      color: var(--text);
    }

    .alert-dismiss {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .alert-dismiss:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }

    /* Setup Checklist Styles */
    .setup-checklist {
      margin: 12px 16px;
      padding: 16px;
      background: rgba(238, 176, 255, 0.08);
      border: 1px solid rgba(238, 176, 255, 0.3);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      animation: slideDown 0.3s ease;
    }

    .checklist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .checklist-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-2);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checklist-dismiss {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .checklist-dismiss:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }

    .checklist-items {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .checklist-items li {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--muted);
      transition: color 0.2s;
    }

    .checklist-items li i {
      font-size: 16px;
      width: 20px;
      flex-shrink: 0;
    }

    .checklist-items li.done {
      color: var(--accent);
    }

    .checklist-items li.done i {
      color: var(--accent);
    }

    .checklist-items li a {
      color: var(--accent-2);
      text-decoration: none;
      font-weight: 500;
    }

    .checklist-items li a:hover {
      text-decoration: underline;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .alert,
      .setup-checklist {
        margin: 8px;
        padding: 10px 12px;
      }

      .alert-content p,
      .checklist-items li {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <a href="index.html" class="active"><i class="fas fa-comments"></i> Chat</a>
    <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Operations</a>
    <a href="n8n-monitor.html"><i class="fas fa-network-wired"></i> n8n Monitor</a>
    <a href="benchmark.html"><i class="fas fa-rocket"></i> Benchmark</a>
    <a href="analytics.html"><i class="fas fa-chart-line"></i> Analytics</a>
    <a href="prompts.html"><i class="fas fa-code"></i> Prompts</a>
    <a href="profile.html"><i class="fas fa-user-circle"></i> Profile</a>
  </nav>
  <div class="bg-grid"></div>
  <div class="page history-hidden" style="padding-top: 80px;">
    <aside class="sidebar">
      <div class="sidebar-head">
        <h2>History</h2>
        <div class="sidebar-actions">
          <button id="newChatBtn" class="icon-btn" title="New Chat">+</button>
          <button id="closeHistoryBtn" class="icon-btn" title="Hide history">Ã—</button>
        </div>
      </div>
      <div id="historyList" class="history-list">
        <!-- History items will be injected here -->
      </div>
    </aside>

    <div class="main-content app-layout" style="padding-top: 0;">
    <header class="hero">
      <div class="hero-content">
        <div class="eyebrow">AgentX â€¢ Control</div>
        <div class="title-row">
          <h1><i class="fas fa-robot"></i><span class="title-separator"></span>AgentX Control</h1>
          <span class="status-chip" id="statusChip">Idle</span>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
             <button id="toggleHistoryBtn" class="ghost small">Show history</button>
             <button id="showChatTutorialBtn" class="ghost small" title="Show Tutorial">
               <i class="fas fa-graduation-cap"></i> Tutorial
             </button>
             <button id="profileBtn" class="ghost small">User Profile</button>
             <button id="loginBtn" class="ghost small" style="display: none;">Login</button>
             <div id="userMenu" class="user-menu" style="display: none;">
                <span id="userName" class="user-name"></span>
                <button id="logoutBtn" class="ghost small">Logout</button>
             </div>
        </div>

        <p class="lede">
          AI control surface wired to the AgentX SBQC chat, memory, and feedback APIs. 
          Pick a model, tune parameters, and manage the session profile that the assistant will remember.
        </p>
      </div>
    </header>

    <main class="layout">
      <section class="panel chat">
        <div class="panel-head">
          <div>
            <p class="eyebrow">Conversation</p>
            <h2>AI Dialogue</h2>
          </div>
          <div class="controls">
            <div class="pill inline" style="margin-right: 12px;">
              <span class="label">Config</span>
              <strong id="chatConfigSummary" style="font-size: 11px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" data-tooltip="Current model and settings">â€”</strong>
            </div>
            <div class="pill inline" style="margin-right: 12px;">
              <span class="label">Prompt</span>
              <strong id="activePromptName" style="font-size: 11px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" data-tooltip="Active system prompt">â€”</strong>
            </div>
            <div class="pill inline">
              <span class="label">Messages</span>
              <strong id="statMessages">0</strong>
            </div>
            <button class="ghost small" id="toggleLogBtn">Show session log</button>
          </div>
        </div>

        <!-- Profile Prompt Alert -->
        <div class="alert alert-info" id="profilePrompt" style="display: none;">
          <i class="fas fa-info-circle"></i>
          <div class="alert-content">
            <p>Enhance your experience! <a href="/profile.html">Set up your profile</a> to give the AI context about you.</p>
          </div>
          <button class="alert-dismiss" onclick="dismissProfilePrompt()" title="Dismiss">Ã—</button>
        </div>

        <!-- Setup Checklist -->
        <div class="setup-checklist" id="setupChecklist" style="display: none;">
          <div class="checklist-header">
            <h4><i class="fas fa-rocket"></i> Getting Started</h4>
            <button class="checklist-dismiss" onclick="dismissChecklist()" title="Dismiss">Ã—</button>
          </div>
          <ul class="checklist-items">
            <li class="done"><i class="fas fa-check-circle"></i> <span>Account created</span></li>
            <li id="profileCheck"><i class="far fa-circle"></i> <a href="/profile.html">Complete your profile</a></li>
            <li id="firstChatCheck"><i class="far fa-circle"></i> <span>Send your first message</span></li>
            <li id="ragCheck"><i class="far fa-circle"></i> <span>Try RAG search (toggle in config)</span></li>
          </ul>
        </div>

        <div class="chat-window" id="chatWindow">
          <div class="bubble assistant">
            <div class="meta">AgentX</div>
            <p>Hello! Iâ€™m online. Pick a model, then ask away.</p>
          </div>
        </div>

        <div class="composer">
          <div class="quick-actions">
            <button class="chip" data-quick="What can you help me with?" data-tooltip="Ask the AI about its capabilities and available features">Help</button>
            <button class="chip" data-quick="Summarize recent events." data-tooltip="Get a summary of your recent conversation history">Summary</button>
            <button class="chip" data-quick="List available tools." data-tooltip="View all tools and commands available to the AI agent">Tools</button>
            <button class="chip" data-quick="Brainstorm next steps for my project." data-tooltip="Get creative suggestions and ideas for your project">Brainstorm</button>
          </div>
          <textarea id="messageInput" rows="3" placeholder="Type to your agent..."></textarea>
          <div class="composer-actions">
            <button class="icon-btn" id="micBtn" title="Voice Input" aria-label="Voice Input" aria-pressed="false">ðŸŽ¤</button>
            <div class="flex-spacer"></div>
            <button class="ghost small" id="clearBtn">Clear chat</button>
            <button class="primary" id="sendBtn">Send</button>
          </div>
        </div>

        <div class="log-panel collapsed">
          <div class="panel-head">
            <div>
              <p class="eyebrow">Session log</p>
              <h3>Recent exchanges</h3>
            </div>
            <div class="pill inline">Thread <span id="threadId"></span></div>
          </div>
          <div class="log-window" id="logWindow"></div>
        </div>
      </section>

      <aside class="panel config collapsible-panel collapsed" id="configPanel">
        <div class="panel-head tight clickable" id="configPanelHeader">
          <div>
            <p class="eyebrow">Models & memory</p>
            <h2>Configuration <span class="panel-toggle-icon">â–¼</span></h2>
          </div>
        </div>

        <!-- Config Summary (shown when panel collapsed) -->
        <div class="config-summary" id="configSummary" style="display: block;">
          <div class="summary-items">
            <span class="summary-item"><strong>Model:</strong> <span id="summaryModel">â€”</span></span>
            <span class="summary-item"><strong>RAG:</strong> <span id="summaryRag">Off</span></span>
            <span class="summary-item"><strong>Stream:</strong> <span id="summaryStream">On</span></span>
            <span class="summary-item"><strong>Temp:</strong> <span id="summaryTemp">0.7</span></span>
          </div>
        </div>

        <div class="config-body" id="configBody">

        <div class="field">
          <label>Target host</label>
          <div class="input-row">
            <select id="hostInput" style="flex: 1;">
              <option value="localhost">localhost</option>
              <option value="127.0.0.1">127.0.0.1</option>
              <option value="192.168.2.12">192.168.2.12</option>
              <option value="192.168.2.99">192.168.2.99</option>
            </select>
            <input type="text" id="portInput" class="w-96" value="11434">
          </div>
        </div>

        <div class="field">
          <label>Model</label>
          <div class="input-row">
            <select id="modelSelect" style="flex: 1;">
              <option value="">Load available modelsâ€¦</option>
            </select>
            <button class="icon-btn" id="refreshModels" title="Refresh models from Ollama">â†»</button>
          </div>
          <div class="hint">Models are pulled from the selected Ollama host.</div>
        </div>

        <div class="field">
          <label>System Prompt</label>
          <div class="input-row">
            <select id="promptSelect" style="flex: 1;">
              <option value="default_chat">Loading promptsâ€¦</option>
            </select>
            <button class="icon-btn" id="promptInfoBtn" title="View prompt details">â“˜</button>
          </div>
          <div class="hint">Choose which system prompt to use for AI behavior.</div>
        </div>

        <div class="note" id="feedback">Waiting for configuration.</div>

        <div class="field inline-toggle" data-tooltip="Real-time streaming shows AI responses as they're generated. Recommended for longer answers and thinking models.">
          <label>Streaming</label>
          <label class="switch">
            <input type="checkbox" id="streamToggle" checked>
            <span class="slider"></span>
          </label>
          <div class="hint">Stream responses in real-time (recommended for thinking models).</div>
        </div>

        <div class="field inline-toggle" data-tooltip="RAG (Retrieval-Augmented Generation) enhances responses by retrieving relevant context from your stored documents and conversation history.">
          <label>Enable RAG</label>
          <label class="switch">
            <input type="checkbox" id="ragToggle" checked>
            <span class="slider"></span>
          </label>
          <div class="hint">Retrieve context from vector store.</div>
        </div>

        <div class="field inline-toggle">
          <label>TTS Output</label>
          <label class="switch">
            <input type="checkbox" id="ttsToggle">
            <span class="slider"></span>
          </label>
          <div class="hint">Read responses aloud (Browser TTS).</div>
        </div>

        <div class="field inline-toggle">
          <label>Show Message Stats</label>
          <label class="switch">
            <input type="checkbox" id="statsToggle" checked>
            <span class="slider"></span>
          </label>
          <div class="hint">Display token usage and timing for each message.</div>
        </div>

        <div class="field">
          <label>System prompt</label>
          <textarea id="systemPrompt" rows="3">You are AgentX, a concise and capable local assistant. Keep answers brief and actionable.</textarea>
        </div>

        <div class="collapsible-section">
          <div class="section-header" id="tuningHeader">
            <h3>Model Tuning Parameters <span class="panel-toggle-icon">â–¼</span></h3>
          </div>
          <div class="section-content hidden" id="tuningContent">

        <div class="options-grid">
          <div class="field">
            <label>Temperature</label>
            <input type="range" id="temperature" min="0" max="2" step="0.05" value="0.7">
            <div class="value" data-for="temperature">0.7</div>
          </div>
          <div class="field">
            <label>Top P</label>
            <input type="range" id="topP" min="0" max="1" step="0.01" value="0.9">
            <div class="value" data-for="topP">0.9</div>
          </div>
          <div class="field">
            <label>Top K</label>
            <input type="number" id="topK" value="64" min="1" max="32000">
          </div>
          <div class="field">
            <label>Context (tokens)</label>
            <input type="number" id="numCtx" value="4096" min="256" max="32000" step="256">
          </div>
          <div class="field">
            <label>Repeat penalty</label>
            <input type="number" id="repeatPenalty" value="1.05" min="0" max="2" step="0.01">
          </div>
          <div class="field">
            <label>Presence penalty</label>
            <input type="number" id="presencePenalty" value="0" min="-2" max="2" step="0.01">
          </div>
          <div class="field">
            <label>Frequency penalty</label>
            <input type="number" id="frequencyPenalty" value="0" min="-2" max="2" step="0.01">
          </div>
          <div class="field">
            <label>Num predict</label>
            <input type="number" id="numPredict" value="256" min="16" max="4096" step="16">
          </div>
          <div class="field">
            <label>Seed</label>
            <input type="number" id="seed" value="" placeholder="random">
          </div>
          <div class="field">
            <label>Stop sequences</label>
            <input type="text" id="stopSequences" placeholder="e.g. ###,END">
          </div>
          <div class="field">
            <label>Keep alive</label>
            <input type="text" id="keepAlive" placeholder="e.g. 30s or -1">
            <div class="hint">Keep the model warm between calls.</div>
          </div>
        </div>

        <div class="action-row">
          <button class="primary full" id="saveDefaults">Save defaults</button>
        </div>

          </div>
        </div>

        </div> <!-- End config-body -->
      </aside>
    </main>
    </div> <!-- End main-content -->
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>User Profile & Memory</h2>
        <button id="closeProfileBtn" class="close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label>About You (Memory)</label>
          <div class="hint">Facts the agent should remember about you (e.g., job, interests, background).</div>
          <textarea id="userAbout" rows="5" placeholder="I am a software engineer interested in AI..."></textarea>
        </div>
        <div class="field">
          <label>Preferred Language</label>
          <input type="text" id="memoryLanguage" placeholder="English">
        </div>
        <div class="field">
          <label>Role / Context</label>
          <input type="text" id="memoryRole" placeholder="e.g. Product manager focusing on UX">
        </div>
        <div class="field">
          <label>Response Style</label>
          <textarea id="memoryStyle" rows="2" placeholder="Concise, decisive, include next steps."></textarea>
        </div>
        <div class="field">
          <label>Custom Instructions</label>
          <div class="hint">How the agent should behave (e.g., always be concise).</div>
          <textarea id="userInstructions" rows="3" placeholder="Be brief and professional."></textarea>
        </div>
        <div class="hint">All profile data is saved to your AgentX database and persisted across conversations.</div>
        <div class="action-row">
          <button class="ghost" id="resetProfileBtn">Reset</button>
          <button class="primary" id="saveProfileBtn">Save Profile</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Import Base and ChatOnboardingWizard components
    import { BaseOnboardingWizard } from '/js/components/BaseOnboardingWizard.js';
    import { ChatOnboardingWizard } from '/js/components/ChatOnboardingWizard.js';

    // Initialize chat onboarding wizard (make globally accessible)
    window.chatOnboardingWizard = null;

    // Check if user needs chat onboarding
    function checkChatOnboarding() {
      const hasSeenOnboarding = localStorage.getItem('agentx_chat_onboarding_seen') === 'true';

      // Check if user has conversation history (using localStorage as proxy)
      const hasConversations = localStorage.getItem('agentx_last_conversation_id') !== null;

      // Show wizard if: first visit AND no chat history
      if (!hasSeenOnboarding && !hasConversations) {
        localStorage.setItem('agentx_chat_onboarding_seen', 'true');
        setTimeout(() => {
          if (window.chatOnboardingWizard) {
            window.chatOnboardingWizard.open();
          }
        }, 1000); // Wait 1 second for page to settle
      }
    }

    // Initialize wizard when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize wizard (assuming toast is available globally from chat.js)
      setTimeout(() => {
        const toast = window.toast || {
          success: (msg) => console.log('Success:', msg),
          error: (msg) => console.error('Error:', msg)
        };

        window.chatOnboardingWizard = new ChatOnboardingWizard(toast);

        // Manual trigger button
        const tutorialBtn = document.getElementById('showChatTutorialBtn');
        if (tutorialBtn) {
          tutorialBtn.addEventListener('click', () => {
            window.chatOnboardingWizard.open();
          });
        }

        // Check if we should auto-trigger onboarding
        checkChatOnboarding();
      }, 500); // Wait for chat.js to load and initialize toast
    });
  </script>
  <script>
    // Phase 3 Navigation Improvements

    // 1. Profile Prompt Alert Functions
    function dismissProfilePrompt() {
      const alert = document.getElementById('profilePrompt');
      if (alert) {
        alert.style.display = 'none';
        localStorage.setItem('agentx_profile_prompt_dismissed', 'true');
      }
    }

    async function checkProfileSetup() {
      // Don't show if already dismissed
      if (localStorage.getItem('agentx_profile_prompt_dismissed') === 'true') {
        return;
      }

      try {
        const res = await fetch('/api/profile');
        const { data } = await res.json();

        // Show alert if profile is empty
        if (!data.about || data.about.trim() === '') {
          const alert = document.getElementById('profilePrompt');
          if (alert) {
            alert.style.display = 'flex';
          }
        }
      } catch (err) {
        console.log('Could not check profile setup:', err);
      }
    }

    // 2. Setup Checklist Functions
    function dismissChecklist() {
      const checklist = document.getElementById('setupChecklist');
      if (checklist) {
        checklist.style.display = 'none';
        localStorage.setItem('agentx_checklist_dismissed', 'true');
      }
    }

    function updateChecklistItem(itemId, isDone) {
      const item = document.getElementById(itemId);
      if (item) {
        if (isDone) {
          item.classList.add('done');
          item.innerHTML = '<i class="fas fa-check-circle"></i> ' +
            (item.querySelector('a') ? item.querySelector('a').outerHTML : '<span>' + item.textContent + '</span>');
        } else {
          item.classList.remove('done');
        }
      }
    }

    async function checkSetupProgress() {
      // Don't show if already dismissed
      if (localStorage.getItem('agentx_checklist_dismissed') === 'true') {
        return;
      }

      const progress = {
        profile: false,
        firstChat: false,
        ragUsed: false
      };

      try {
        // Check profile completion
        const profileRes = await fetch('/api/profile');
        const { data: profileData } = await profileRes.json();
        progress.profile = profileData.about && profileData.about.trim() !== '';

        // Check if user has sent messages (via conversation history)
        const historyRes = await fetch('/api/history');
        const historyData = await historyRes.json();
        progress.firstChat = historyData.data && historyData.data.length > 0;

        // Check if RAG has been used (look for conversations with RAG enabled)
        if (progress.firstChat && historyData.data.length > 0) {
          progress.ragUsed = historyData.data.some(conv =>
            conv.useRag === true || (conv.ragSources && conv.ragSources.length > 0)
          );
        }

        // Update checklist items
        updateChecklistItem('profileCheck', progress.profile);
        updateChecklistItem('firstChatCheck', progress.firstChat);
        updateChecklistItem('ragCheck', progress.ragUsed);

        // Show checklist if not all complete
        const allComplete = progress.profile && progress.firstChat && progress.ragUsed;
        if (!allComplete) {
          const checklist = document.getElementById('setupChecklist');
          if (checklist) {
            checklist.style.display = 'block';
          }
        } else {
          // Auto-dismiss if all complete
          localStorage.setItem('agentx_checklist_dismissed', 'true');
        }

      } catch (err) {
        console.log('Could not check setup progress:', err);
      }
    }

    // 3. Make functions globally accessible for chat.js integration
    window.dismissProfilePrompt = dismissProfilePrompt;
    window.dismissChecklist = dismissChecklist;
    window.updateChecklistItem = updateChecklistItem;
    window.checkSetupProgress = checkSetupProgress;
    window.checkProfileSetup = checkProfileSetup;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Wait a bit for auth and profile to load
      setTimeout(() => {
        checkProfileSetup();
        checkSetupProgress();
      }, 1000);
    });

    // Re-check when user saves profile (listen for storage events from profile page)
    window.addEventListener('storage', (e) => {
      if (e.key === 'agentx_profile_updated') {
        checkProfileSetup();
        checkSetupProgress();
        localStorage.removeItem('agentx_profile_updated');
      }
    });
  </script>
  <script src="/js/chat.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AgentX • Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
  
  <!-- Bootstrap 5 (Required for DataAPI views) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="css/sbqc.css" />
  
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
      /* Override Bootstrap conflicts with AgentX styles where necessary */
      body {
          background-color: #0f172a; /* AgentX dark theme */
          color: #e2e8f0;
      }
      .card {
          background-color: rgba(30, 41, 59, 0.7);
          border: 1px solid rgba(148, 163, 184, 0.1);
          color: #e2e8f0;
      }
      .text-primary { color: #38bdf8 !important; }
      .bg-light { background-color: #0f172a !important; }
      
      /* Nav adjustments */
      .agentx-nav a {
          color: #94a3b8;
          text-decoration: none;
          margin-right: 1rem;
          font-family: 'Space Grotesk', sans-serif;
      }
      .agentx-nav a.active {
          color: #f8fafc;
          font-weight: 600;
      }
      .agentx-nav a:hover {
          color: #e2e8f0;
      }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  
  <div class="container-fluid p-4">
      <header class="mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="text-uppercase text-muted small fw-bold">AgentX • Dashboard</div>
            <h1 class="display-6 fw-bold">DataAPI Dashboard</h1>
          </div>
          <nav class="agentx-nav">
            <a href="/">Chat</a>
            <a href="/analytics.html">Analytics</a>
            <a href="/metrics.html">Metrics</a>
            <a href="/dataapi.html">Data Tools</a>
            <a href="/dashboard.html" class="active">Dashboard</a>
            <a href="/file-browser.html">Files</a>
            <a href="/databases.html">Databases</a>
          </nav>
        </div>
      </header>

      <div class="row g-4">
        <!-- Sidebar / Stats -->
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title">Collections</h5>
                    <div id="card-scroll-container" style="max-height: 600px; overflow-y: auto;">
                        <!-- Populated by JS -->
                        <div class="text-center text-muted p-3">Loading stats...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Map Area -->
        <div class="col-md-9">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">World <span id="worldMapTitle" class="text-primary fw-bold"></span></h5>
                    <canvas id="worldMap" style="width: 100%; height: 500px;"></canvas>
                </div>
            </div>
            
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="toggleMapDataFeed">
                <label class="form-check-label" for="toggleMapDataFeed">Show Data Feed</label>
            </div>
            
            <div class="card shadow-sm" id="mapDataFeedCard" style="display: none;">
                <div class="card-body" id="mapDataFeed"></div>
            </div>
        </div>
    </div>

    <!-- Feed Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="mb-0"><i class="fas fa-stream me-2"></i>Live Event Feed</h5>
                </div>
                <div class="card-body p-0">
                    <div class="feed-scroll-container" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-dark table-hover mb-0">
                            <tbody>
                                <tr class="no-items-row"><td colspan="3" class="text-center p-3">Waiting for events...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-geo"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <!-- Custom dashboard script -->
  <script src="/js/dashboard.js"></script>

  <!-- Load utility modules and initialize dashboard -->
  <script type="module">
      import { API, DOM, General } from '/js/utils/index.js';
      import { initFeed as initializeSSE } from '/js/utils/sse.js'; 
      
      // Expose utils to window for legacy scripts
      window.API = API;
      window.DOM = DOM;
      window.General = General;

      async function loadStats() {
          const container = document.getElementById('card-scroll-container');
          try {
              const response = await API.get('/stats');
              const stats = response.data; // Array of { db, collection, count }
              
              if (!stats || stats.length === 0) {
                  container.innerHTML = '<div class="text-center text-muted p-3">No collections found.</div>';
                  return;
              }

              container.innerHTML = ''; // Clear loading message

              stats.forEach(stat => {
                  const card = document.createElement('div');
                  card.className = 'summary-card p-3 mb-2 rounded cursor-pointer hover-bg-light';
                  // Add styling for card to match original look if needed
                  card.style.border = '1px solid rgba(255,255,255,0.1)';
                  card.style.backgroundColor = 'rgba(255,255,255,0.05)';
                  
                  card.setAttribute('data-collection', stat.collection);
                  // Add selected class if it's userLogs (default)
                  if (stat.collection === 'userLogs') {
                      card.classList.add('selected');
                      card.style.backgroundColor = 'rgba(56, 189, 248, 0.2)'; // Highlight
                  }
                  
                  card.innerHTML = `
                      <div class="d-flex justify-content-between align-items-center">
                          <div>
                              <h6 class="mb-0 fw-bold text-light">${stat.collection}</h6>
                              <small class="text-muted">${stat.db}</small>
                          </div>
                          <span class="badge bg-primary rounded-pill">${stat.count}</span>
                      </div>
                  `;
                  
                  // Add click effect for selection styling
                  card.addEventListener('click', () => {
                      document.querySelectorAll('.summary-card').forEach(c => {
                          c.classList.remove('selected');
                          c.style.backgroundColor = 'rgba(255,255,255,0.05)';
                      });
                      card.classList.add('selected');
                      card.style.backgroundColor = 'rgba(56, 189, 248, 0.2)';
                  });

                  container.appendChild(card);
              });

              // Initialize interactions after rendering
              if (window.setupDashboardInteractions) {
                  window.setupDashboardInteractions();
              }

          } catch (error) {
              console.error('Failed to load stats:', error);
              container.innerHTML = '<div class="text-center text-danger p-3">Failed to load stats.</div>';
          }
      }

      // Start loading
      loadStats();
  </script>
</body>
</html>
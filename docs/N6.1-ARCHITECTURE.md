# N6.1 SBQC Workflow Architect - Architecture

## Overview

The SBQC Workflow Architect is an AI-powered system that generates, validates, and deploys n8n workflows from natural language descriptions. It uses AgentX's AI capabilities with RAG to learn from existing workflow patterns and create production-ready automation.

## System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    User Request (Natural Language)           │
│              "Create a workflow that monitors X"             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ POST /webhook/sbqc-workflow-architect
                         │ { "description": "...", "autoActivate": true }
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                     N6.1 - Workflow Architect                │
│                  (n8n Webhook Workflow)                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  1. Webhook Trigger                                          │
│     └─> Receives natural language description                │
│                                                               │
│  2. Validate Request                                         │
│     └─> Check required fields                                │
│                                                               │
│  3. Prepare Context (Code Node)                              │
│     ├─> Load workflow templates                              │
│     ├─> Load existing workflows as examples                  │
│     ├─> Build comprehensive AI prompt                        │
│     └─> Include validation requirements                      │
│                                                               │
│  4. Call AgentX AI (HTTP Request)                            │
│     ├─> POST http://192.168.2.33:3080/api/chat              │
│     ├─> Persona: "sbqc_workflow_architect"                   │
│     ├─> useRag: true (learns from existing workflows)        │
│     └─> Returns: Generated workflow JSON                     │
│                                                               │
│  5. Parse & Validate Response (Code Node)                    │
│     ├─> Extract JSON from AI response                        │
│     ├─> Validate structure (name, nodes, connections)        │
│     ├─> Check webhook configurations                         │
│     ├─> Validate node connections                            │
│     └─> Generate validation report                           │
│                                                               │
│  6. Save to File (Code Node)                                 │
│     └─> Write workflow JSON to AgentC/N6.x-generated.json    │
│                                                               │
│  7. Deploy Workflow (HTTP Request or Bash)                   │
│     ├─> Call /api/n8n/deploy OR                              │
│     └─> Execute ../scripts/deploy-workflow-auto.sh           │
│                                                               │
│  8. Activate Workflow (if autoActivate = true)               │
│     └─> POST /api/v1/workflows/{id}/activate                 │
│                                                               │
│  9. Format Response (Code Node)                              │
│     └─> Build comprehensive response with workflow details   │
│                                                               │
│  10. Respond to Webhook                                      │
│      └─> Return JSON with workflow info and webhook URL      │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## Component Breakdown

### 1. Workflow Templates Library

**Location:** `AgentC/templates/workflow-templates.json`

Reusable workflow patterns:
- Basic webhook workflow (GET/POST)
- Scheduled job pattern (cron trigger)
- Conditional flow (IF nodes, error handling)
- Multi-step API integration
- Data processing pipeline
- Notification workflows (Slack/Discord/Email)

Each template includes:
- Complete node configurations
- Connection structure
- Position coordinates
- Code examples with comments
- Parameter placeholders

### 2. Workflow Generation Persona

**Location:** `personas/sbqc_workflow_architect.json`

Specialized AI persona trained to:
- Generate valid n8n workflow JSON
- Follow SBQC naming conventions (N0.x-N9.x)
- Use proper node types and parameters
- Create clean connection graphs
- Include error handling patterns
- Generate unique webhookIds
- Calculate visual positions for nodes

System prompt includes:
- n8n node type reference
- Connection format specification
- SBQC workflow standards
- Validation checklist
- Example workflows for each category

### 3. Validation Pipeline

**Validation Steps:**

1. **Structure Validation**
   - Required fields: name, nodes, connections, settings
   - JSON syntax correctness

2. **Node Validation**
   - Each node has: id, name, type, parameters, position
   - Node types are valid n8n types
   - No duplicate node IDs or names

3. **Connection Validation**
   - Connection keys match node names
   - Connection targets exist
   - No orphaned nodes (except triggers)
   - Graph is acyclic (no infinite loops)

4. **Webhook Validation**
   - Webhook nodes have: httpMethod, path, webhookId
   - webhookId is unique across system
   - Path follows naming convention
   - responseMode is valid

5. **Semantic Validation**
   - Workflow achieves stated goal
   - Proper error handling included
   - Appropriate logging configured
   - Follows SBQC best practices

### 4. Deployment Integration

**Options:**

**Option A: Direct n8n API**
```javascript
POST https://n8n.specialblend.icu/api/v1/workflows
Headers: { "X-N8N-API-KEY": "..." }
Body: { name, nodes, connections, settings }
```

**Option B: Bash Script Wrapper**
```bash
/scripts/deploy-workflow-auto.sh AgentC/N6.x-generated.json
```

**Option C: AgentX API Endpoint**
```javascript
POST http://192.168.2.33:3080/api/n8n/deploy
Body: { workflow: {...}, activate: true }
```

### 5. RAG Integration

**Context Sources:**

1. **Existing Workflows** (`AgentC/*.json`)
   - Ingested into AgentX RAG system
   - Searchable by pattern/feature/node type

2. **Workflow Templates** (`AgentC/templates/`)
   - Common patterns and structures
   - Reusable components

3. **SBQC Documentation**
   - Workflow guide (WORKFLOW-GUIDE.md)
   - API documentation (docs/API.md)
   - Architecture patterns

**RAG Query Examples:**
- "Find workflows that use webhook triggers"
- "Show examples of error handling in SBQC workflows"
- "Get the structure of scheduled workflows"
- "Find workflows that call AgentX API"

## Data Flow

### Request Example

```json
POST /webhook/sbqc-workflow-architect

{
  "description": "Create a workflow that checks if AgentX response time is over 10 seconds and sends a Discord notification with the details",
  "autoActivate": true,
  "options": {
    "includeErrorHandling": true,
    "logToDataAPI": true
  }
}
```

### AI Prompt Construction

```markdown
You are the SBQC Workflow Architect. Generate a valid n8n workflow JSON.

USER REQUEST:
"Create a workflow that checks if AgentX response time is over 10 seconds
and sends a Discord notification with the details"

REQUIREMENTS:
- Follow SBQC naming convention (assign next available N-number)
- Include proper webhookId (lowercase, hyphenated)
- Use AgentX API endpoint: http://192.168.2.33:3080
- Discord webhook: (user will provide)
- Include error handling
- Log events to DataAPI: http://192.168.2.33:3003

EXAMPLE WORKFLOWS:
[RAG retrieves similar workflows]

TEMPLATES AVAILABLE:
- Conditional Flow Pattern (for IF logic)
- Scheduled Job Pattern (if monitoring needed)
- HTTP Request Pattern (for API calls)

OUTPUT FORMAT:
Return only valid JSON with this structure:
{
  "name": "SBQC - N6.2 AgentX Performance Monitor",
  "nodes": [...],
  "connections": {...},
  "settings": { "executionOrder": "v1" },
  "tags": [...]
}
```

### Response Example

```json
{
  "success": true,
  "workflow": {
    "id": "xEpwABc8r5h1KLmN",
    "name": "SBQC - N6.2 AgentX Performance Monitor",
    "active": true
  },
  "webhook": {
    "method": "POST",
    "url": "https://n8n.specialblend.icu/webhook/agentx-perf-monitor"
  },
  "generatedJson": { ... },
  "validation": {
    "passed": true,
    "warnings": [],
    "suggestions": [
      "Consider adding retry logic for Discord webhook"
    ]
  },
  "deploymentLog": "✓ Valid JSON\n✓ Structure validated\n✓ Deployed successfully\n✓ Activated"
}
```

## Error Handling

### Validation Errors

```json
{
  "success": false,
  "error": "Workflow validation failed",
  "validation": {
    "passed": false,
    "errors": [
      "Missing required field: nodes[2].parameters.url",
      "Connection references non-existent node: 'Process Data'",
      "webhookId 'test-webhook' already in use"
    ]
  },
  "generatedJson": { ... }
}
```

### Deployment Errors

```json
{
  "success": false,
  "error": "Deployment failed",
  "reason": "n8n API returned 400: Invalid node configuration",
  "deploymentLog": "...",
  "generatedJson": { ... }
}
```

## Security Considerations

1. **Input Validation**
   - Sanitize natural language descriptions
   - Prevent injection of malicious code in workflows
   - Validate URLs and endpoints

2. **Workflow Sandboxing**
   - Generated workflows should not access sensitive data
   - Limit API endpoints to approved list
   - Require authentication for deployment

3. **Rate Limiting**
   - Limit workflow generation requests per IP/user
   - Prevent abuse of AI generation

4. **Audit Logging**
   - Log all generation requests
   - Track deployed workflows
   - Monitor for suspicious patterns

## Performance Optimization

1. **Caching**
   - Cache workflow templates in memory
   - Cache RAG results for common patterns
   - Reuse validation logic

2. **Parallel Processing**
   - Validate while AI generates
   - Pre-load templates on workflow start

3. **Incremental Improvement**
   - Learn from successful generations
   - Update templates based on usage patterns
   - Refine persona based on validation feedback

## Future Enhancements

1. **Interactive Refinement**
   - Multi-turn conversation to refine workflow
   - Ask clarifying questions before generation
   - Preview workflow visually before deployment

2. **Workflow Library**
   - Save frequently generated workflows
   - Share workflows across team
   - Version control for generated workflows

3. **A/B Testing**
   - Generate multiple workflow variations
   - Test performance of different approaches
   - Auto-select best performing version

4. **Self-Healing**
   - Detect failing workflows
   - Auto-generate fixes
   - Apply patches automatically

5. **Natural Language Workflow Editing**
   - "Add a 5-second delay before the notification"
   - "Change the threshold to 15 seconds"
   - "Add error logging to DataAPI"

## Testing Strategy

### Unit Tests
- Validate workflow structure validation logic
- Test node connection graph algorithms
- Verify webhookId uniqueness checking

### Integration Tests
- Test full generation pipeline
- Verify deployment to n8n works
- Test RAG context retrieval

### End-to-End Tests
- Real natural language requests
- Deploy to test n8n instance
- Trigger generated workflows
- Verify expected behavior

### Test Cases

1. **Simple Webhook Workflow**
   - "Create a workflow that returns the current time"
   - Validate: 1 webhook node, 1 code node, 1 response node

2. **Conditional Logic**
   - "Create a workflow that checks if X > 10 and does Y"
   - Validate: IF node, proper branching

3. **API Integration**
   - "Create a workflow that calls API X and processes the result"
   - Validate: HTTP request node, proper error handling

4. **Scheduled Job**
   - "Create a workflow that runs daily at 3am"
   - Validate: Schedule trigger node, proper cron expression

5. **Complex Multi-Step**
   - "Create a workflow that fetches data from A, processes it, stores in B, and notifies C"
   - Validate: Multiple nodes, proper data flow

## Deployment Checklist

- [ ] Persona created and tested
- [ ] Workflow templates library complete
- [ ] N6.1 workflow JSON created
- [ ] Validation logic implemented
- [ ] Deployment integration tested
- [ ] RAG context prepared
- [ ] Error handling comprehensive
- [ ] Documentation complete
- [ ] Example prompts documented
- [ ] Integration tests passing
- [ ] Deployed to n8n
- [ ] Webhook endpoint tested
- [ ] Monitor page updated

## Success Metrics

- **Generation Success Rate:** % of requests that produce valid workflows
- **Deployment Success Rate:** % of generated workflows that deploy successfully
- **Validation Pass Rate:** % of workflows that pass all validation checks
- **User Satisfaction:** Quality of generated workflows (human review)
- **Time to Deploy:** Average time from request to active workflow
- **Reuse Rate:** % of generated workflows that are used repeatedly

## Support & Troubleshooting

### Common Issues

**Issue:** AI generates invalid JSON
- **Solution:** Refine persona prompt, add more examples

**Issue:** Connections reference wrong node names
- **Solution:** Update template examples, add validation feedback loop

**Issue:** Deployment fails with API error
- **Solution:** Check n8n API key, verify network connectivity

**Issue:** Generated workflow doesn't match description
- **Solution:** Improve natural language understanding, add clarifying questions

### Debug Mode

Enable verbose logging:
```json
{
  "description": "...",
  "debug": true
}
```

Returns additional information:
- AI prompt sent
- RAG context retrieved
- Validation step-by-step results
- Deployment logs

## Documentation Links

- [SBQC Workflow Guide](./WORKFLOW-GUIDE.md)
- [n8n API Documentation](https://docs.n8n.io/api/)
- [AgentX API](./API.md)
- [Deployment Scripts](../scripts/)
- [Workflow Templates](../AgentC/templates/)

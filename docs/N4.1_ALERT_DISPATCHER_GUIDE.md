# N4.1 Alert Dispatcher Workflow - Implementation Guide

**Workflow:** SBQC - N4.1 Alert Dispatcher  
**Purpose:** Centralized alert notification delivery via webhook  
**Status:** ✅ Complete  
**Date:** 2026-01-02

---

## Overview

The N4.1 Alert Dispatcher workflow receives alert notifications from AgentX via webhook and handles multi-channel delivery (Slack, Email) with delivery status tracking.

## Architecture

```
AlertService (AgentX)
    │
    ├─> Create Alert in MongoDB
    │
    └─> POST webhook → N4.1 Alert Dispatcher
                            │
                            ├─> Check channels array
                            │
                            ├─> Send to Slack (if "slack" in channels)
                            │   └─> Update delivery status
                            │
                            ├─> Send to Email (if "email" in channels)
                            │   └─> Update delivery status
                            │
                            └─> Return success response
```

## Webhook Configuration

### Environment Variable
Add to AgentX `.env`:
```bash
# N4.1 Alert Dispatcher Webhook
N8N_ALERT_WEBHOOK_URL=http://localhost:5678/webhook/sbqc-n4-1-alert-dispatch
```

### Webhook Endpoint
- **URL:** `http://localhost:5678/webhook/sbqc-n4-1-alert-dispatch`
- **Method:** POST
- **Auth:** None (internal network)

### Webhook Payload

```json
{
  "alertId": "mongodb-objectid",
  "ruleId": "rule-identifier",
  "ruleName": "Human-readable rule name",
  "severity": "critical|warning|info",
  "title": "Alert title",
  "message": "Detailed alert message",
  "channels": ["slack", "email", "webhook"],
  "context": {
    "component": "component-id",
    "metric": "metric-name",
    "currentValue": 123,
    "threshold": 100,
    "trend": "degrading",
    "additionalData": {}
  },
  "createdAt": "2026-01-02T23:45:00.000Z",
  "source": "agentx|n8n|dataapi|external"
}
```

## Workflow Nodes

### 1. Webhook Trigger
- **Type:** `n8n-nodes-base.webhook`
- **Path:** `sbqc-n4-1-alert-dispatch`
- **Method:** POST
- **Response Mode:** Last node

### 2. Extract Alert Data
- **Type:** `n8n-nodes-base.set`
- **Purpose:** Parse and validate webhook payload
- **Outputs:** alertId, severity, title, message, channels, context, ruleName, timestamp

### 3. Should Send Slack?
- **Type:** `n8n-nodes-base.if`
- **Condition:** `channels` array contains "slack"
- **True:** Route to Format Slack Message
- **False:** Route to Skip Slack

### 4. Should Send Email?
- **Type:** `n8n-nodes-base.if`
- **Condition:** `channels` array contains "email"
- **True:** Route to Send Email
- **False:** Route to Skip Email

### 5. Format Slack Message
- **Type:** `n8n-nodes-base.markdown`
- **Purpose:** Generate markdown-formatted Slack message

### 6. Send to Slack
- **Type:** `n8n-nodes-base.slack`
- **Channel:** Configured via Slack credentials
- **Format:** Structured blocks with:
  - Severity icon and header
  - Alert message
  - Context details (rule, time, component, metric)
  - Alert ID footer

### 7. Send Email
- **Type:** `n8n-nodes-base.emailSend`
- **From:** `alerts@sbqc.local`
- **To:** Extracted from `context.notifyEmail` or default `admin@sbqc.local`
- **Subject:** `[SEVERITY] Title`
- **Format:** HTML with severity-colored header

### 8. Update Delivery Status
- **Type:** `n8n-nodes-base.httpRequest`
- **Endpoint:** `POST /api/alerts/:id/delivery-status`
- **Purpose:** Track delivery success/failure for each channel
- **Auth:** AgentX API Key

### 9. Merge Results & Response
- **Type:** `n8n-nodes-base.merge` + `respondToWebhook`
- **Purpose:** Aggregate delivery results and return to caller

## Credentials Required

### 1. Slack API Credentials
**Type:** `slackApi`  
**Setup:**
1. Create Slack app at https://api.slack.com/apps
2. Add OAuth scopes: `chat:write`, `chat:write.public`
3. Install app to workspace
4. Copy Bot User OAuth Token
5. Add to n8n credentials

### 2. SMTP Credentials
**Type:** `smtp`  
**Setup:**
1. Configure SMTP server details
2. Add to n8n credentials
3. Test with dummy email

### 3. AgentX API Key
**Type:** `httpHeaderAuth`  
**Setup:**
1. Use `x-api-key` header
2. Value from `AGENTX_API_KEY` environment variable
3. Must match AgentX server configuration

## AlertService Integration

The AlertService automatically triggers the N4.1 webhook when creating alerts:

```javascript
// In alertService.js
async _sendNotifications(alert, channels) {
  // First, trigger n8n webhook if configured
  if (process.env.N8N_ALERT_WEBHOOK_URL) {
    try {
      await this._triggerN8nWebhook(alert);
      logger.info('N8n alert webhook triggered', { alertId: alert._id });
    } catch (error) {
      logger.warn('N8n webhook failed, falling back to direct delivery', { 
        error: error.message 
      });
    }
  }
  
  // Fallback: direct delivery...
}
```

## Delivery Status Tracking

After each channel delivery attempt, the workflow calls:

```http
POST /api/alerts/:alertId/delivery-status
Content-Type: application/json
x-api-key: ${AGENTX_API_KEY}

{
  "channel": "slack|email|webhook",
  "status": "sent|error",
  "timestamp": "2026-01-02T23:45:00.000Z",
  "messageId": "optional-slack-ts",
  "error": "optional-error-message"
}
```

This updates the Alert document in MongoDB:

```json
{
  "deliveryStatus": {
    "slack": {
      "sent": true,
      "sentAt": "2026-01-02T23:45:01.000Z",
      "messageId": "1234567890.123456"
    },
    "email": {
      "sent": true,
      "sentAt": "2026-01-02T23:45:02.000Z"
    }
  }
}
```

## Testing

### 1. Manual Test via curl

```bash
# Trigger N4.1 webhook directly
curl -X POST http://localhost:5678/webhook/sbqc-n4-1-alert-dispatch \
  -H "Content-Type: application/json" \
  -d '{
    "alertId": "test-alert-123",
    "severity": "warning",
    "title": "Test Alert",
    "message": "This is a test alert",
    "channels": ["slack"],
    "context": {
      "component": "test-component",
      "metric": "test-metric"
    },
    "ruleName": "Test Rule",
    "createdAt": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
  }'
```

### 2. Test via AgentX API

```bash
# Create alert via AgentX (triggers webhook automatically)
curl -X POST http://localhost:3080/api/alerts/evaluate \
  -H "Content-Type: application/json" \
  -d '{
    "source": "test-component",
    "data": {
      "responseTime": 6000
    }
  }'
```

### 3. Verify Delivery Status

```bash
# Check alert delivery status
curl http://localhost:3080/api/alerts/:alertId \
  -H "x-api-key: ${AGENTX_API_KEY}"
```

## Error Handling

### Webhook Timeout
- **Timeout:** 5 seconds per HTTP request
- **Behavior:** `continueOnFail: true` on all external calls
- **Fallback:** AlertService logs warning and attempts direct delivery

### Slack Delivery Failure
- Updates delivery status with error
- Does not block email delivery
- Error logged to AgentX logs

### Email Delivery Failure
- Updates delivery status with error
- Does not affect Slack delivery
- Error logged to AgentX logs

### Network Issues
- AlertService falls back to direct delivery methods
- Duplicate delivery prevented by deduplication fingerprint
- All errors logged to MongoDB and winston logs

## Performance

- **Webhook latency:** ~50-100ms
- **Slack delivery:** ~200-500ms
- **Email delivery:** ~500-1000ms
- **Total time:** ~1-2 seconds for dual-channel delivery

## Monitoring

### Workflow Execution History
- View in n8n UI: Executions tab
- Filter by workflow name: "SBQC - N4.1 Alert Dispatcher"
- Check success/failure rates

### Alert Delivery Metrics
```bash
# Query delivery statistics
curl http://localhost:3080/api/alerts/stats/summary \
  -H "x-api-key: ${AGENTX_API_KEY}"
```

### AgentX Logs
```bash
# Check webhook triggers
pm2 logs agentx | grep "N8n alert webhook"

# Check delivery failures
pm2 logs agentx | grep "Notification failed"
```

## Troubleshooting

### Webhook Not Triggered

1. Check environment variable:
   ```bash
   echo $N8N_ALERT_WEBHOOK_URL
   ```

2. Verify n8n workflow is active:
   - Open n8n UI
   - Check "SBQC - N4.1 Alert Dispatcher" is active (toggle on)

3. Check AgentX logs:
   ```bash
   pm2 logs agentx --lines 100 | grep webhook
   ```

### Slack Messages Not Sending

1. Verify Slack credentials in n8n
2. Check bot has `chat:write` permissions
3. Verify channel ID is correct
4. Test with n8n's "Test" button

### Email Not Sending

1. Check SMTP credentials in n8n
2. Verify SMTP server is reachable
3. Check firewall rules
4. Test email delivery separately

### Delivery Status Not Updating

1. Verify AgentX API key in n8n credentials
2. Check AgentX is accessible from n8n
3. Verify alert ID is valid MongoDB ObjectId
4. Check AgentX `/api/alerts/:id/delivery-status` endpoint

## Next Steps

1. **T4.3:** Integrate with SelfHealingEngine for auto-remediation alerts
2. **T1.10:** Build dashboard to visualize alert delivery statistics
3. **T5.1:** Add workflow testing automation
4. **Custom Channels:** Add SMS, PagerDuty, or other notification channels

---

**File Location:** `/home/yb/codes/AgentX/AgentC/N4.1.json`  
**Dependencies:** AlertService, Alert API routes, n8n  
**Status:** Production-ready ✅

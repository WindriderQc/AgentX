# SBQC Stack Expansion - Architecture Senior

**Date:** 31 DÃ©cembre 2025
**Architect:** Senior Technical Lead
**Status:** Design Phase - Ready for Implementation

---

## ğŸ¯ Executive Summary

Ce document prÃ©sente l'architecture pour **Ã©tendre le SBQC Stack** avec deux nouveaux use cases majeurs, tout en amÃ©liorant le systÃ¨me de prompts agents pour n8n et Ollama.

**Objectifs:**
1. âœ… **LLM Benchmark Dashboard** - Automatiser tests multi-host avec mÃ©triques comparatives
2. âœ… **Datalake Janitor** - Nettoyage intelligent et organisation automatique
3. âœ… **Agent Prompt Framework** - SystÃ¨me rÃ©utilisable de profils/prompts pour agents

**Principes:**
- ğŸ”’ StabilitÃ©: Pas de grands refactors, build sur l'existant
- ğŸš€ IncrÃ©mental: Features ajoutÃ©es par petits morceaux testables
- ğŸ”Œ Pluggable: Nouveaux modules s'intÃ¨grent sans casser l'existant
- ğŸ“Š Observable: MÃ©triques et dashboards pour tout

---

## ğŸ“ Architecture Globale - Vue d'Ensemble

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SBQC Stack - Expanded                               â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        USER INTERFACES (New)                            â”‚ â”‚
â”‚  â”‚                                                                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  LLM Benchmark   â”‚  â”‚  Janitor         â”‚  â”‚  Agent Prompt        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Dashboard       â”‚  â”‚  Dashboard       â”‚  â”‚  Manager UI          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  (Web UI)        â”‚  â”‚  (Web UI)        â”‚  â”‚  (CRUD Interface)    â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚                    â”‚                      â”‚                   â”‚
â”‚              â–¼                    â–¼                      â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    NEW: BENCHMARK SERVICE                            â”‚   â”‚
â”‚  â”‚                    (Port: 3081)                                      â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ Test Runner â”‚  â”‚ Metric Store â”‚  â”‚ Dashboard   â”‚  â”‚ Schedulerâ”‚  â”‚   â”‚
â”‚  â”‚  â”‚ (Multi-LLM) â”‚  â”‚ (TimeSeries) â”‚  â”‚ API         â”‚  â”‚ (Cron)   â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Routes:                                                             â”‚   â”‚
â”‚  â”‚  POST /api/benchmark/test        - Run single test                  â”‚   â”‚
â”‚  â”‚  POST /api/benchmark/suite       - Run test suite                   â”‚   â”‚
â”‚  â”‚  GET  /api/benchmark/results     - Get results                      â”‚   â”‚
â”‚  â”‚  GET  /api/benchmark/compare     - Compare models                   â”‚   â”‚
â”‚  â”‚  GET  /api/benchmark/dashboard   - Dashboard data                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    NEW: JANITOR SERVICE                              â”‚   â”‚
â”‚  â”‚                    (Integrated in DataAPI)                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ Analyzer    â”‚  â”‚ Rule Engine  â”‚  â”‚ Executor    â”‚  â”‚ Reporter â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ (AI-based)  â”‚  â”‚ (Policies)   â”‚  â”‚ (Actions)   â”‚  â”‚ (Stats)  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Routes (DataAPI Extension):                                        â”‚   â”‚
â”‚  â”‚  POST /api/v1/janitor/analyze    - Analyze datalake                â”‚   â”‚
â”‚  â”‚  POST /api/v1/janitor/suggest    - Get cleanup suggestions         â”‚   â”‚
â”‚  â”‚  POST /api/v1/janitor/execute    - Execute cleanup plan            â”‚   â”‚
â”‚  â”‚  GET  /api/v1/janitor/report     - Get janitor report              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ENHANCED: AGENTX                                  â”‚   â”‚
â”‚  â”‚                    (192.168.2.33:3080)                               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  NEW: Agent Prompt Framework                                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Prompt         â”‚  â”‚ Template       â”‚  â”‚ Variable       â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ Registry       â”‚  â”‚ Engine         â”‚  â”‚ Injector       â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ (CRUD)         â”‚  â”‚ (Jinja2-like)  â”‚  â”‚ (Context)      â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                                â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  New Routes:                                                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  GET    /api/prompts             - List all prompts           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  POST   /api/prompts             - Create prompt              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  GET    /api/prompts/:id         - Get prompt                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  PUT    /api/prompts/:id         - Update prompt              â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  POST   /api/prompts/:id/render  - Render with variables      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  GET    /api/prompts/tags/:tag   - Get by tag                 â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Database (MongoDB agentx):                                          â”‚   â”‚
â”‚  â”‚  - agentprompts (new collection)                                     â”‚   â”‚
â”‚  â”‚  - prompttemplates (new collection)                                  â”‚   â”‚
â”‚  â”‚  - promptexecutions (new collection - audit trail)                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    ENHANCED: N8N WORKFLOWS                           â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  NEW Workflows:                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚  N4.1: LLM Benchmark Runner (Scheduled Daily)              â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Trigger: Cron (4AM daily)                             â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Call Benchmark Service â†’ Test all models              â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Store results â†’ MongoDB                               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Generate report â†’ Email/Slack                         â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚  N4.2: Datalake Janitor (Scheduled Weekly)                 â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Trigger: Cron (Sunday 3AM)                            â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Call Janitor Service â†’ Analyze                        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Get suggestions â†’ RAG context                         â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - LLM decision â†’ Execute or defer                       â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Report â†’ Dashboard                                    â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚  N4.3: Agent Prompt Versioning                             â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Webhook: On prompt update                             â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Version snapshot â†’ Git/MongoDB                        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - A/B test setup â†’ PromptConfig                         â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Notify â†’ Slack/Email                                  â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  ENHANCED Workflows:                                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚  N2.3: RAG Ingestion (Enhanced)                            â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Use Agent Prompt Framework                            â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Variable injection: {user, context, task}             â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Quality check with LLM                                â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚  N3.2: External AI Gateway (Enhanced)                      â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Prompt templates per task type                        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - MCP Google integration (Search, Calendar, Drive)      â”‚     â”‚   â”‚
â”‚  â”‚  â”‚    - Tools HTTP (DataAPI/AgentX)                           â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¬ Use Case 1: LLM Benchmark Dashboard

### Vision

SystÃ¨me automatisÃ© pour tester, mesurer, et comparer la performance de tous les LLMs du cluster Ollama avec un dashboard temps rÃ©el.

### Architecture DÃ©taillÃ©e

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LLM BENCHMARK ARCHITECTURE                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  n8n Scheduler  â”‚
â”‚  (4AM Daily)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Benchmark Service (New)                          â”‚
â”‚                    Port: 3081                                       â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Test Runner                                                  â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  For each model on each host:                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ Load test suite (questions.json)                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ Execute tests in parallel                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ Measure: latency, tokens/sec, memory, quality            â”‚  â”‚
â”‚  â”‚  â”œâ”€ Store raw results                                        â”‚  â”‚
â”‚  â”‚  â””â”€ Generate aggregates                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  Test Categories:                                                   â”‚
â”‚  â”œâ”€ Speed: Simple Q&A (10 questions)                               â”‚
â”‚  â”œâ”€ Quality: Complex reasoning (5 questions with scoring)          â”‚
â”‚  â”œâ”€ Coding: Code generation (5 tasks with validation)              â”‚
â”‚  â”œâ”€ RAG: Context retrieval accuracy (10 queries)                   â”‚
â”‚  â”œâ”€ Load: Concurrent requests (stress test)                        â”‚
â”‚  â””â”€ Stability: Long-running conversation (error rate)              â”‚
â”‚                                                                     â”‚
â”‚  Metrics Collected:                                                 â”‚
â”‚  â”œâ”€ Response time (p50, p95, p99)                                  â”‚
â”‚  â”œâ”€ Tokens per second                                              â”‚
â”‚  â”œâ”€ GPU memory usage                                               â”‚
â”‚  â”œâ”€ CPU usage                                                      â”‚
â”‚  â”œâ”€ Quality score (LLM-as-judge)                                   â”‚
â”‚  â”œâ”€ Context window utilization                                     â”‚
â”‚  â””â”€ Error rate                                                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               MongoDB (agentx.benchmark_results)                     â”‚
â”‚                                                                      â”‚
â”‚  Document Schema:                                                    â”‚
â”‚  {                                                                   â”‚
â”‚    _id: ObjectId,                                                    â”‚
â”‚    timestamp: ISODate,                                               â”‚
â”‚    run_id: "2025-12-31-04:00",                                       â”‚
â”‚    model: "qwen2.5:7b",                                              â”‚
â”‚    host: "192.168.2.99",                                             â”‚
â”‚    category: "speed",                                                â”‚
â”‚    metrics: {                                                        â”‚
â”‚      latency_p50: 123,                                               â”‚
â”‚      latency_p95: 456,                                               â”‚
â”‚      tokens_per_sec: 45.6,                                           â”‚
â”‚      quality_score: 8.5,                                             â”‚
â”‚      gpu_memory_mb: 8192,                                            â”‚
â”‚      error_rate: 0.0                                                 â”‚
â”‚    },                                                                â”‚
â”‚    test_details: [...],                                              â”‚
â”‚    comparison: {                                                     â”‚
â”‚      vs_previous: "+5.2%",                                           â”‚
â”‚      vs_baseline: "-2.1%"                                            â”‚
â”‚    }                                                                 â”‚
â”‚  }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Dashboard API (Benchmark Service)                 â”‚
â”‚                                                                      â”‚
â”‚  GET /api/benchmark/dashboard                                        â”‚
â”‚  Returns:                                                            â”‚
â”‚  {                                                                   â”‚
â”‚    overview: {                                                       â”‚
â”‚      total_models: 8,                                                â”‚
â”‚      total_hosts: 2,                                                 â”‚
â”‚      last_run: "2025-12-31 04:00",                                   â”‚
â”‚      next_run: "2026-01-01 04:00"                                    â”‚
â”‚    },                                                                â”‚
â”‚    leaderboard: [                                                    â”‚
â”‚      {model: "deepseek-r1:8b", overall_score: 9.2, ...},             â”‚
â”‚      {model: "qwen2.5-coder:14b", overall_score: 8.9, ...}           â”‚
â”‚    ],                                                                â”‚
â”‚    trends: {                                                         â”‚
â”‚      speed: [...time series data...],                                â”‚
â”‚      quality: [...time series data...]                               â”‚
â”‚    },                                                                â”‚
â”‚    host_comparison: {                                                â”‚
â”‚      ugfrank: {avg_latency: 120ms, ...},                             â”‚
â”‚      ugbrutal: {avg_latency: 180ms, ...}                             â”‚
â”‚    }                                                                 â”‚
â”‚  }                                                                   â”‚
â”‚                                                                      â”‚
â”‚  GET /api/benchmark/compare?models=qwen,llama                        â”‚
â”‚  Returns side-by-side comparison                                    â”‚
â”‚                                                                      â”‚
â”‚  POST /api/benchmark/test                                            â”‚
â”‚  Body: {model, host, category}                                       â”‚
â”‚  Runs single test on-demand                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Web Dashboard (Static HTML/JS)                    â”‚
â”‚                    Served by Benchmark Service                       â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Leaderboard   â”‚  â”‚  Host Compare  â”‚  â”‚  Trend Charts   â”‚       â”‚
â”‚  â”‚  (Table)       â”‚  â”‚  (Bar Chart)   â”‚  â”‚  (Line Graph)   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Model Detail  â”‚  â”‚  Run History   â”‚  â”‚  Manual Trigger â”‚       â”‚
â”‚  â”‚  (Drill-down)  â”‚  â”‚  (Timeline)    â”‚  â”‚  (Button)       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                      â”‚
â”‚  Tech Stack: Chart.js, Alpine.js (lightweight)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Plan

**Phase 1: Core Service (Week 1-2)**
```javascript
// /home/yb/codes/BenchmarkService/
â”œâ”€â”€ server.js                 // Express server
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ testRunner.js         // Test execution engine
â”‚   â”œâ”€â”€ metricCollector.js    // Metric gathering
â”‚   â”œâ”€â”€ scorer.js             // LLM-as-judge quality scoring
â”‚   â””â”€â”€ scheduler.js          // Cron job manager
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ speed.json            // Speed test questions
â”‚   â”œâ”€â”€ quality.json          // Quality test questions
â”‚   â”œâ”€â”€ coding.json           // Coding test tasks
â”‚   â””â”€â”€ rag.json              // RAG test queries
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ models.json           // Model definitions
â”‚   â””â”€â”€ hosts.json            // Ollama host configs
â””â”€â”€ public/
    â””â”€â”€ dashboard/            // Web UI
        â”œâ”€â”€ index.html
        â”œâ”€â”€ app.js
        â””â”€â”€ styles.css
```

**Phase 2: n8n Integration (Week 2)**
- Create N4.1 workflow
- Webhook: `POST /webhook/sbqc-n4-1-benchmark`
- Scheduled trigger: Daily 4AM
- Actions:
  1. Call BenchmarkService `/api/benchmark/suite`
  2. Wait for completion
  3. Fetch results
  4. Generate summary report
  5. Send to Slack/Email

**Phase 3: Dashboard (Week 3)**
- Web UI with Chart.js
- Real-time updates (SSE)
- Historical comparison
- Export reports (CSV/PDF)

### API Specification

```javascript
// POST /api/benchmark/suite
{
  "models": ["qwen2.5:7b", "llama3.3:70b"],  // Or "all"
  "hosts": ["192.168.2.99", "192.168.2.12"], // Or "all"
  "categories": ["speed", "quality", "coding"], // Or "all"
  "parallel": true,
  "timeout": 300000 // 5 min per test
}

// Response:
{
  "status": "running",
  "run_id": "2025-12-31-04:00",
  "estimated_duration": "15 minutes",
  "progress_url": "/api/benchmark/status/2025-12-31-04:00"
}

// GET /api/benchmark/results/:run_id
{
  "run_id": "2025-12-31-04:00",
  "status": "completed",
  "started_at": "2025-12-31T04:00:00Z",
  "completed_at": "2025-12-31T04:12:34Z",
  "results": [
    {
      "model": "qwen2.5:7b",
      "host": "192.168.2.99",
      "category": "speed",
      "score": 8.5,
      "metrics": {...}
    }
  ],
  "summary": {
    "fastest_model": "qwen2.5:3b",
    "best_quality": "deepseek-r1:8b",
    "most_stable": "llama3.3:70b"
  }
}
```

### Test Suite Example

```json
// tests/speed.json
{
  "category": "speed",
  "description": "Fast Q&A response time",
  "questions": [
    {
      "id": "speed_01",
      "prompt": "What is the capital of France?",
      "expected_tokens": 5,
      "timeout": 5000
    },
    {
      "id": "speed_02",
      "prompt": "Calculate 15 * 23",
      "expected_tokens": 3,
      "timeout": 5000
    }
  ],
  "scoring": {
    "latency_weight": 0.5,
    "accuracy_weight": 0.3,
    "token_efficiency_weight": 0.2
  }
}

// tests/quality.json
{
  "category": "quality",
  "description": "Complex reasoning and accuracy",
  "questions": [
    {
      "id": "quality_01",
      "prompt": "Explain the Monty Hall problem and why switching doors increases your odds.",
      "judge_prompt": "Rate the accuracy and clarity of this explanation on a scale of 1-10. Consider mathematical correctness, clarity, and completeness.",
      "timeout": 30000
    }
  ],
  "scoring": {
    "judge_model": "qwen2.5:14b", // Use best model as judge
    "criteria": ["accuracy", "clarity", "completeness", "reasoning"]
  }
}
```

---

## ğŸ§¹ Use Case 2: Datalake Janitor

### Vision

Agent AI intelligent qui analyse le datalake, dÃ©tecte les problÃ¨mes (duplicates, fichiers obsolÃ¨tes, mauvaise organisation), et propose/exÃ©cute des actions de nettoyage automatisÃ©es.

### Architecture DÃ©taillÃ©e

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DATALAKE JANITOR ARCHITECTURE                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  n8n Scheduler  â”‚
â”‚  (Weekly)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Janitor Service (DataAPI Extension)                    â”‚
â”‚              New routes in DataAPI                                  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Phase 1: Analysis                                            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Analyzer Module:                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ Scan datalake (use existing NAS scanner)                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ Detect duplicates (SHA256 hash matching)                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ Find obsolete files (last access > 1 year)               â”‚  â”‚
â”‚  â”‚  â”œâ”€ Identify orphaned files (no parent folder structure)     â”‚  â”‚
â”‚  â”‚  â”œâ”€ Check naming conventions                                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ Analyze folder structure inefficiencies                  â”‚  â”‚
â”‚  â”‚  â””â”€ Calculate storage waste                                  â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  AI Analysis (via AgentX + RAG):                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ Ingest file metadata â†’ Qdrant                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ Semantic search for similar content                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ Suggest folder reorganization                            â”‚  â”‚
â”‚  â”‚  â””â”€ Generate cleanup recommendations                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Phase 2: Rule Engine                                         â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Policies (Configurable):                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ Policy: Delete Duplicates                             â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Trigger: Files with same SHA256                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Action: Keep newest, mark others for deletion         â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Approval: Required if total size > 10GB               â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ Policy: Archive Old Files                             â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Trigger: Last access > 365 days                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Action: Move to /archive/<year>/<month>/              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Approval: Auto (log only)                             â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ Policy: Organize by Type                              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Trigger: Mixed file types in same folder              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Action: Suggest subfolder structure                   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Approval: Required (user review)                      â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Decision Engine:                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ Apply policies to findings                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ Calculate risk score (0-10)                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ Generate action plan                                      â”‚  â”‚
â”‚  â”‚  â””â”€ Route: Auto-execute, require approval, or defer          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Phase 3: Execution                                           â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Executor Module (Safe Operations):                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ Dry-run mode (default)                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ Backup before delete                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ Transaction log (rollback support)                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ Rate limiting (avoid I/O spikes)                         â”‚  â”‚
â”‚  â”‚  â””â”€ Progress tracking                                        â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Actions Supported:                                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ DELETE: Move to trash (30-day retention)                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ MOVE: Relocate file                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ RENAME: Fix naming conventions                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ DEDUPE: Keep one, symlink others                         â”‚  â”‚
â”‚  â”‚  â””â”€ TAG: Add metadata labels                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            MongoDB (SBQC.janitor_* collections)                      â”‚
â”‚                                                                      â”‚
â”‚  Collections:                                                        â”‚
â”‚  â”œâ”€ janitor_runs                                                     â”‚
â”‚  â”‚   {                                                               â”‚
â”‚  â”‚     _id, timestamp, status, duration,                             â”‚
â”‚  â”‚     findings: {duplicates: 42, obsolete: 123, ...},               â”‚
â”‚  â”‚     actions: {executed: 10, pending: 32, skipped: 0},             â”‚
â”‚  â”‚     storage_saved: "15.2 GB"                                      â”‚
â”‚  â”‚   }                                                               â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€ janitor_findings                                                 â”‚
â”‚  â”‚   {                                                               â”‚
â”‚  â”‚     _id, run_id, type, file_path, issue,                          â”‚
â”‚  â”‚     recommendation, risk_score, status,                           â”‚
â”‚  â”‚     action_taken, timestamp                                       â”‚
â”‚  â”‚   }                                                               â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€ janitor_policies                                                 â”‚
â”‚  â”‚   {                                                               â”‚
â”‚  â”‚     _id, name, enabled, trigger_condition,                        â”‚
â”‚  â”‚     action, approval_required, created_at, updated_at             â”‚
â”‚  â”‚   }                                                               â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â””â”€ janitor_actions                                                  â”‚
â”‚      {                                                                â”‚
â”‚        _id, finding_id, action_type, status,                         â”‚
â”‚        executed_at, rollback_data, success, error                    â”‚
â”‚      }                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Dashboard (AgentX Web UI)                         â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Overview      â”‚  â”‚  Findings      â”‚  â”‚  Policy Editor  â”‚       â”‚
â”‚  â”‚  - Last run    â”‚  â”‚  - By type     â”‚  â”‚  - CRUD         â”‚       â”‚
â”‚  â”‚  - Storage     â”‚  â”‚  - Risk score  â”‚  â”‚  - Enable/      â”‚       â”‚
â”‚  â”‚    saved       â”‚  â”‚  - Actions     â”‚  â”‚    Disable      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Action Queue  â”‚  â”‚  History       â”‚  â”‚  Manual Trigger â”‚       â”‚
â”‚  â”‚  - Pending     â”‚  â”‚  - Timeline    â”‚  â”‚  - Analyze      â”‚       â”‚
â”‚  â”‚  - Approve/    â”‚  â”‚  - Rollback    â”‚  â”‚  - Execute      â”‚       â”‚
â”‚  â”‚    Reject      â”‚  â”‚                â”‚  â”‚                 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Plan

**Phase 1: Analysis Engine (Week 1-2)**
```javascript
// /home/yb/codes/DataAPI/src/janitor/
â”œâ”€â”€ analyzer.js           // File analysis logic
â”œâ”€â”€ detector.js           // Issue detection
â”œâ”€â”€ policies.js           // Policy engine
â”œâ”€â”€ executor.js           // Action execution
â””â”€â”€ reporter.js           // Report generation

// New routes in DataAPI
// routes/janitor.routes.js
router.post('/janitor/analyze', requireAuth, janitorController.analyze);
router.get('/janitor/findings/:run_id', requireAuth, janitorController.findings);
router.post('/janitor/execute', requireAuth, rbac(['admin']), janitorController.execute);
router.get('/janitor/policies', requireAuth, janitorController.listPolicies);
router.put('/janitor/policies/:id', requireAuth, rbac(['admin']), janitorController.updatePolicy);
```

**Phase 2: AI-Enhanced Analysis (Week 3)**
- Integrate with AgentX RAG
- Semantic file similarity detection
- LLM-based folder structure suggestions
- Natural language policy queries

**Phase 3: Safe Execution (Week 4)**
- Dry-run mode
- Transaction logging
- Rollback support
- Approval workflow

### API Specification

```javascript
// POST /api/v1/janitor/analyze
{
  "scope": "/mnt/datalake",
  "deep_analysis": true,  // Use AI/RAG
  "policies": ["duplicates", "obsolete", "organize"]
}

// Response:
{
  "status": "completed",
  "run_id": "janitor-2025-12-31",
  "summary": {
    "files_scanned": 125000,
    "duplicates_found": 42,
    "storage_wasted": "15.2 GB",
    "obsolete_files": 123,
    "organization_issues": 8
  },
  "findings": [
    {
      "id": "finding_001",
      "type": "duplicate",
      "file_path": "/mnt/datalake/videos/movie.mkv",
      "duplicate_of": "/mnt/datalake/backup/movie.mkv",
      "size": "1.2 GB",
      "recommendation": "Delete older copy (backup/movie.mkv)",
      "risk_score": 2,
      "status": "pending_approval"
    }
  ],
  "action_plan": {
    "auto_executable": 10,
    "requires_approval": 32,
    "deferred": 0
  }
}

// POST /api/v1/janitor/execute
{
  "run_id": "janitor-2025-12-31",
  "actions": ["finding_001", "finding_002"],
  "dry_run": false,
  "approval_token": "<admin_jwt>"
}

// Response:
{
  "status": "executing",
  "execution_id": "exec_123",
  "progress_url": "/api/v1/janitor/status/exec_123"
}
```

### Janitor Policies Configuration

```javascript
// MongoDB: SBQC.janitor_policies
{
  _id: "policy_duplicates",
  name: "Delete Duplicate Files",
  enabled: true,
  trigger: {
    condition: "files_with_same_sha256",
    threshold: 2
  },
  action: {
    type: "DELETE",
    keep: "newest",  // or "largest", "oldest"
    delete_others: true,
    move_to_trash: true
  },
  approval: {
    required: true,
    if: "total_size > 10GB",
    auto_approve: false
  },
  scheduling: {
    auto_run: true,
    frequency: "weekly"
  }
}

{
  _id: "policy_archive_old",
  name: "Archive Old Files",
  enabled: true,
  trigger: {
    condition: "last_access_days > 365",
    file_types: ["video", "audio", "document"]
  },
  action: {
    type: "MOVE",
    destination: "/mnt/datalake/archive/{year}/{month}/",
    create_structure: true
  },
  approval: {
    required: false,  // Auto-execute
    notify: true
  }
}
```

---

## ğŸ­ Use Case 3: Agent Prompt Framework

### Vision

SystÃ¨me centralisÃ© et rÃ©utilisable pour gÃ©rer les prompts agents, avec templating, versioning, A/B testing, et injection de variables pour n8n workflows et requÃªtes Ollama.

### Architecture DÃ©taillÃ©e

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               AGENT PROMPT FRAMEWORK ARCHITECTURE                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MongoDB (agentx Database)                        â”‚
â”‚                                                                     â”‚
â”‚  NEW Collections:                                                   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  agentprompts                                                 â”‚  â”‚
â”‚  â”‚  {                                                            â”‚  â”‚
â”‚  â”‚    _id: ObjectId,                                             â”‚  â”‚
â”‚  â”‚    name: "data_analysis_expert",                              â”‚  â”‚
â”‚  â”‚    description: "Analyzes data with statistical rigor",       â”‚  â”‚
â”‚  â”‚    version: "1.2.0",                                          â”‚  â”‚
â”‚  â”‚    template: "You are {{role}}. Context: {{context}}...",     â”‚  â”‚
â”‚  â”‚    variables: [                                               â”‚  â”‚
â”‚  â”‚      {name: "role", type: "string", required: true},          â”‚  â”‚
â”‚  â”‚      {name: "context", type: "string", default: "general"}    â”‚  â”‚
â”‚  â”‚    ],                                                          â”‚  â”‚
â”‚  â”‚    tags: ["analysis", "expert", "data"],                      â”‚  â”‚
â”‚  â”‚    category: "specialist",                                    â”‚  â”‚
â”‚  â”‚    usage_count: 142,                                          â”‚  â”‚
â”‚  â”‚    avg_rating: 4.5,                                           â”‚  â”‚
â”‚  â”‚    created_by: "admin",                                       â”‚  â”‚
â”‚  â”‚    created_at: ISODate,                                       â”‚  â”‚
â”‚  â”‚    updated_at: ISODate,                                       â”‚  â”‚
â”‚  â”‚    active: true                                               â”‚  â”‚
â”‚  â”‚  }                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  prompttemplates (Reusable Blocks)                            â”‚  â”‚
â”‚  â”‚  {                                                            â”‚  â”‚
â”‚  â”‚    _id: ObjectId,                                             â”‚  â”‚
â”‚  â”‚    name: "rag_context_injector",                              â”‚  â”‚
â”‚  â”‚    template: "Relevant context:\n{{#each docs}}\n...",        â”‚  â”‚
â”‚  â”‚    type: "block",                                             â”‚  â”‚
â”‚  â”‚    variables: [{name: "docs", type: "array"}]                â”‚  â”‚
â”‚  â”‚  }                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  promptexecutions (Audit Trail)                               â”‚  â”‚
â”‚  â”‚  {                                                            â”‚  â”‚
â”‚  â”‚    _id: ObjectId,                                             â”‚  â”‚
â”‚  â”‚    prompt_id: ObjectId,                                       â”‚  â”‚
â”‚  â”‚    version: "1.2.0",                                          â”‚  â”‚
â”‚  â”‚    variables: {role: "data scientist", ...},                  â”‚  â”‚
â”‚  â”‚    rendered: "Full rendered prompt text...",                  â”‚  â”‚
â”‚  â”‚    source: "n8n_workflow_N3.2",                               â”‚  â”‚
â”‚  â”‚    model: "qwen2.5:7b",                                       â”‚  â”‚
â”‚  â”‚    tokens_used: 342,                                          â”‚  â”‚
â”‚  â”‚    response_quality: 4.5,                                     â”‚  â”‚
â”‚  â”‚    executed_at: ISODate                                       â”‚  â”‚
â”‚  â”‚  }                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AgentX Prompt Service                            â”‚
â”‚                    (New Module)                                     â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Prompt Registry                                              â”‚  â”‚
â”‚  â”‚  - CRUD operations                                            â”‚  â”‚
â”‚  â”‚  - Search by name/tag/category                                â”‚  â”‚
â”‚  â”‚  - Versioning (semantic versioning)                           â”‚  â”‚
â”‚  â”‚  - Import/export (JSON)                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Template Engine                                              â”‚  â”‚
â”‚  â”‚  - Handlebars-like syntax                                     â”‚  â”‚
â”‚  â”‚  - Variable substitution: {{var}}                             â”‚  â”‚
â”‚  â”‚  - Conditionals: {{#if condition}}...{{/if}}                  â”‚  â”‚
â”‚  â”‚  - Loops: {{#each items}}...{{/each}}                         â”‚  â”‚
â”‚  â”‚  - Includes: {{> template_block}}                             â”‚  â”‚
â”‚  â”‚  - Filters: {{var | uppercase}}                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Variable Injector                                            â”‚  â”‚
â”‚  â”‚  - Fetch from context (user profile, RAG, n8n webhook)        â”‚  â”‚
â”‚  â”‚  - Validate required variables                                â”‚  â”‚
â”‚  â”‚  - Apply defaults                                             â”‚  â”‚
â”‚  â”‚  - Type conversion (string, number, array, object)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  A/B Testing Module                                           â”‚  â”‚
â”‚  â”‚  - Multiple prompt versions                                   â”‚  â”‚
â”‚  â”‚  - Traffic splitting (50/50, 80/20, etc.)                     â”‚  â”‚
â”‚  â”‚  - Metric tracking (quality, latency, user satisfaction)      â”‚  â”‚
â”‚  â”‚  - Winner selection (automatic or manual)                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  NEW Routes:                                                        â”‚
â”‚  GET    /api/prompts                  - List all prompts          â”‚
â”‚  POST   /api/prompts                  - Create prompt             â”‚
â”‚  GET    /api/prompts/:id              - Get prompt                â”‚
â”‚  PUT    /api/prompts/:id              - Update prompt             â”‚
â”‚  DELETE /api/prompts/:id              - Delete prompt             â”‚
â”‚  POST   /api/prompts/:id/render       - Render with variables    â”‚
â”‚  GET    /api/prompts/tags/:tag        - Get by tag                â”‚
â”‚  GET    /api/prompts/category/:cat    - Get by category           â”‚
â”‚  POST   /api/prompts/:id/version      - Create new version        â”‚
â”‚  POST   /api/prompts/:id/test         - A/B test setup            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Integration Points                               â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AgentX Chat Service (Enhanced)                               â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Before:                                                      â”‚  â”‚
â”‚  â”‚  const systemPrompt = "You are a helpful assistant...";      â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  After:                                                       â”‚  â”‚
â”‚  â”‚  const promptService = require('./promptService');            â”‚  â”‚
â”‚  â”‚  const systemPrompt = await promptService.render(            â”‚  â”‚
â”‚  â”‚    'helpful_assistant',                                       â”‚  â”‚
â”‚  â”‚    { user: userProfile, context: ragContext }                â”‚  â”‚
â”‚  â”‚  );                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  n8n Workflows (Enhanced)                                     â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Step 1: HTTP Request Node                                    â”‚  â”‚
â”‚  â”‚  POST http://192.168.2.33:3080/api/prompts/:id/render        â”‚  â”‚
â”‚  â”‚  Body: {variables: {user: "...", task: "..."}}               â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Step 2: Ollama Node                                          â”‚  â”‚
â”‚  â”‚  Use rendered prompt from Step 1                              â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Benefits:                                                    â”‚  â”‚
â”‚  â”‚  âœ“ Centralized prompt management                              â”‚  â”‚
â”‚  â”‚  âœ“ Version control in UI (not workflow JSON)                 â”‚  â”‚
â”‚  â”‚  âœ“ A/B testing without workflow changes                       â”‚  â”‚
â”‚  â”‚  âœ“ Reuse across workflows                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Ollama Direct (Tool Use)                                     â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  const prompt = await agentx.renderPrompt('code_reviewer', { â”‚  â”‚
â”‚  â”‚    code: fileContent,                                         â”‚  â”‚
â”‚  â”‚    language: 'javascript',                                    â”‚  â”‚
â”‚  â”‚    focus: 'security'                                          â”‚  â”‚
â”‚  â”‚  });                                                          â”‚  â”‚
â”‚  â”‚  const response = await ollama.generate(model, prompt);      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Management UI (AgentX)                           â”‚
â”‚                    /prompts (Web Interface)                         â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Prompt List   â”‚  â”‚  Prompt Editor â”‚  â”‚  Version        â”‚      â”‚
â”‚  â”‚  - Search      â”‚  â”‚  - Template    â”‚  â”‚  History        â”‚      â”‚
â”‚  â”‚  - Filter tags â”‚  â”‚  - Variables   â”‚  â”‚  - Compare      â”‚      â”‚
â”‚  â”‚  - Categories  â”‚  â”‚  - Preview     â”‚  â”‚  - Rollback     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  A/B Test      â”‚  â”‚  Usage Stats   â”‚  â”‚  Import/Export  â”‚      â”‚
â”‚  â”‚  - Setup       â”‚  â”‚  - Top prompts â”‚  â”‚  - JSON         â”‚      â”‚
â”‚  â”‚  - Monitor     â”‚  â”‚  - Quality     â”‚  â”‚  - Templates    â”‚      â”‚
â”‚  â”‚  - Results     â”‚  â”‚  - Adoption    â”‚  â”‚  - Bulk ops     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Prompt Template Examples

```javascript
// Example 1: Simple Variable Substitution
{
  name: "helpful_assistant",
  template: `You are {{role}}, a friendly and knowledgeable AI assistant.

User Profile:
- Name: {{user.name}}
- Preferences: {{user.preferences}}

{{#if context}}
Relevant Context:
{{context}}
{{/if}}

Please provide helpful, accurate, and concise responses.`,
  variables: [
    {name: "role", type: "string", default: "a helpful assistant"},
    {name: "user.name", type: "string", required: true},
    {name: "user.preferences", type: "string", default: "none specified"},
    {name: "context", type: "string", required: false}
  ]
}

// Example 2: RAG Context Injection
{
  name: "rag_enhanced_assistant",
  template: `{{> system_role}}

Relevant Documents:
{{#each ragDocs}}
- [{{this.source}}] {{this.content}}
{{/each}}

User Query: {{query}}

Instructions:
1. Use the provided documents to answer
2. Cite sources in your response
3. If documents don't contain the answer, say so clearly`,
  variables: [
    {name: "ragDocs", type: "array", required: true},
    {name: "query", type: "string", required: true}
  ],
  includes: ["system_role"]
}

// Example 3: Code Review Specialist
{
  name: "code_reviewer",
  template: `You are a {{language}} code reviewer specializing in {{focus}}.

Code to Review:
\`\`\`{{language}}
{{code}}
\`\`\`

Review Guidelines:
{{#each guidelines}}
- {{this}}
{{/each}}

Provide a structured review with:
1. Security issues (if any)
2. Performance concerns
3. Best practice suggestions
4. Overall assessment`,
  variables: [
    {name: "language", type: "string", required: true},
    {name: "focus", type: "string", default: "general quality"},
    {name: "code", type: "string", required: true},
    {name: "guidelines", type: "array", default: [
      "Check for common vulnerabilities",
      "Assess code readability",
      "Evaluate performance"
    ]}
  ]
}

// Example 4: n8n Workflow Prompt (Janitor)
{
  name: "janitor_decision_maker",
  template: `You are the Datalake Janitor AI, responsible for maintaining data organization.

Analysis Report:
- Files scanned: {{stats.total_files}}
- Duplicates found: {{stats.duplicates}}
- Storage wasted: {{stats.wasted_space}}

Findings:
{{#each findings}}
{{@index}}. {{this.type}}: {{this.file_path}}
   Issue: {{this.issue}}
   Recommendation: {{this.recommendation}}
   Risk Score: {{this.risk_score}}/10
{{/each}}

Policies:
{{#each policies}}
- {{this.name}}: {{this.action}} (approval {{#if this.approval_required}}required{{else}}not required{{/if}})
{{/each}}

Task: Review the findings and generate an execution plan.
For each finding, decide:
1. EXECUTE (safe, low risk <3)
2. APPROVE (needs human review, risk 3-7)
3. DEFER (high risk >7, complex decision)

Respond in JSON format:
{
  "decisions": [
    {"finding_id": "...", "action": "EXECUTE|APPROVE|DEFER", "reason": "..."}
  ],
  "summary": "..."
}`,
  variables: [
    {name: "stats", type: "object", required: true},
    {name: "findings", type: "array", required: true},
    {name: "policies", type: "array", required: true}
  ],
  tags: ["janitor", "decision", "automation"],
  category: "workflow"
}
```

### Implementation Plan

**Phase 1: Core Framework (Week 1)**
```javascript
// /home/yb/codes/AgentX/src/services/promptService.js

class PromptService {
  constructor(db) {
    this.db = db;
    this.templates = new Map();
    this.engine = new TemplateEngine();
  }

  async create(prompt) {
    // Validate template syntax
    // Save to MongoDB
    // Clear cache
  }

  async render(promptName, variables) {
    // Fetch prompt (with caching)
    // Validate variables
    // Apply defaults
    // Render template
    // Log execution
    return renderedPrompt;
  }

  async version(promptId, changes) {
    // Create new version
    // Maintain version history
    // Update references
  }

  async abTest(promptId, variantIds, config) {
    // Setup A/B test
    // Configure traffic split
    // Track metrics
  }
}
```

**Phase 2: n8n Integration (Week 2)**
- Create "Render Agent Prompt" HTTP node template
- Update existing workflows to use prompt service
- Add webhook for prompt version notifications

**Phase 3: Management UI (Week 3)**
- CRUD interface for prompts
- Template editor with syntax highlighting
- Variable management
- A/B test dashboard

---

## ğŸ“‹ Implementation Roadmap - IncrÃ©mental & Stable

### Sprint 1: Foundations (Semaines 1-2)

**Objectif:** Poser les bases sans casser l'existant

**Tasks:**
1. **Agent Prompt Framework - Phase 1**
   - [ ] CrÃ©er collections MongoDB (agentprompts, prompttemplates, promptexecutions)
   - [ ] ImplÃ©menter PromptService (CRUD de base)
   - [ ] Ajouter routes API (`/api/prompts/*`)
   - [ ] Tests unitaires
   - **Effort:** 3 jours
   - **Risk:** Faible (nouveaux modules, pas de modification existant)

2. **Benchmark Service - Core**
   - [ ] Setup nouveau service Express (port 3081)
   - [ ] ImplÃ©menter TestRunner basique
   - [ ] CrÃ©er test suites (speed.json, quality.json)
   - [ ] MongoDB collection (benchmark_results)
   - **Effort:** 4 jours
   - **Risk:** Faible (service isolÃ©)

**Deliverables:**
- âœ… Prompt CRUD fonctionnel
- âœ… Benchmark service rÃ©pond sur port 3081
- âœ… Peut lancer un test manuel

### Sprint 2: Core Features (Semaines 3-4)

**Objectif:** Features fonctionnelles end-to-end

**Tasks:**
1. **Prompt Template Engine**
   - [ ] ImplÃ©mente Handlebars-like renderer
   - [ ] Variable substitution
   - [ ] Conditionals & loops
   - [ ] Tests avec prompts complexes
   - **Effort:** 3 jours

2. **Benchmark - Full Test Suite**
   - [ ] MetricCollector (latency, tokens/sec, memory)
   - [ ] Scorer (LLM-as-judge pour quality)
   - [ ] Parallel execution pour multi-host
   - [ ] Dashboard API endpoints
   - **Effort:** 4 jours

3. **Janitor - Analysis Engine**
   - [ ] Analyzer module (duplicates, obsolete)
   - [ ] Policy engine (configurable rules)
   - [ ] MongoDB collections (janitor_*)
   - [ ] Routes API (`/api/v1/janitor/*`)
   - **Effort:** 5 jours

**Deliverables:**
- âœ… Prompts rendus avec variables dynamiques
- âœ… Benchmark exÃ©cute tests sur tous models/hosts
- âœ… Janitor analyse datalake et gÃ©nÃ¨re findings

### Sprint 3: n8n Integration (Semaines 5-6)

**Objectif:** Automatisation via workflows

**Tasks:**
1. **n8n Workflows - New**
   - [ ] N4.1: LLM Benchmark Runner
   - [ ] N4.2: Datalake Janitor
   - [ ] N4.3: Agent Prompt Versioning
   - **Effort:** 3 jours

2. **n8n Workflows - Enhanced**
   - [ ] N2.3: RAG Ingestion (use prompt framework)
   - [ ] N3.2: External AI Gateway (MCP Google + prompts)
   - **Effort:** 2 jours

3. **Integration Testing**
   - [ ] Test end-to-end flows
   - [ ] Verify webhook triggers
   - [ ] Load testing
   - **Effort:** 2 jours

**Deliverables:**
- âœ… Benchmark runs automatiquement daily
- âœ… Janitor runs automatiquement weekly
- âœ… Prompts versionnÃ©s via n8n

### Sprint 4: Dashboards & UI (Semaines 7-8)

**Objectif:** Interfaces utilisateur

**Tasks:**
1. **Benchmark Dashboard**
   - [ ] Web UI (Chart.js + Alpine.js)
   - [ ] Leaderboard
   - [ ] Trend charts
   - [ ] Model comparison
   - **Effort:** 4 jours

2. **Janitor Dashboard**
   - [ ] Findings viewer
   - [ ] Action queue (approve/reject)
   - [ ] Policy editor
   - [ ] History timeline
   - **Effort:** 4 jours

3. **Prompt Management UI**
   - [ ] Prompt CRUD interface
   - [ ] Template editor (syntax highlighting)
   - [ ] Version history
   - [ ] A/B test setup
   - **Effort:** 4 jours

**Deliverables:**
- âœ… Dashboard benchmark accessible via browser
- âœ… Dashboard janitor avec approval workflow
- âœ… UI prompt management complet

### Sprint 5: Advanced Features (Semaines 9-10)

**Objectif:** Features avancÃ©es

**Tasks:**
1. **Prompt A/B Testing**
   - [ ] Traffic splitting logic
   - [ ] Metrics tracking
   - [ ] Winner selection
   - **Effort:** 3 jours

2. **Janitor - AI-Enhanced Analysis**
   - [ ] Integrate AgentX RAG for semantic similarity
   - [ ] LLM decision-making for complex cases
   - [ ] Safe execution with rollback
   - **Effort:** 4 jours

3. **Benchmark - Advanced Metrics**
   - [ ] GPU monitoring
   - [ ] Context window tests
   - [ ] Stress testing
   - [ ] Historical comparison
   - **Effort:** 3 jours

**Deliverables:**
- âœ… A/B testing fonctionnel avec auto-winner
- âœ… Janitor utilise RAG pour suggestions
- âœ… Benchmark complet avec all metrics

### Sprint 6: Polish & Production (Semaine 11)

**Objectif:** Production-ready

**Tasks:**
1. **Documentation**
   - [ ] API documentation (OpenAPI)
   - [ ] User guides
   - [ ] Architecture diagrams
   - [ ] Troubleshooting guide
   - **Effort:** 2 jours

2. **Testing & QA**
   - [ ] Integration tests
   - [ ] Load testing
   - [ ] Security review
   - [ ] Performance optimization
   - **Effort:** 2 jours

3. **Deployment**
   - [ ] PM2 configuration
   - [ ] Monitoring setup
   - [ ] Backup procedures
   - [ ] Rollout plan
   - **Effort:** 1 jour

**Deliverables:**
- âœ… Documentation complÃ¨te
- âœ… All tests passing
- âœ… Production deployment successful

---

## ğŸ“Š Success Metrics

### LLM Benchmark Dashboard
- âœ… Tests running daily without failures
- âœ… All 8+ models tested on both hosts
- âœ… Dashboard shows clear winner/loser
- âœ… Historical trends visible
- âœ… <5min to run full suite

### Datalake Janitor
- âœ… Weekly scans completing successfully
- âœ… >10GB storage saved per month
- âœ… 90%+ accuracy on duplicate detection
- âœ… <5% false positives on obsolete files
- âœ… Zero accidental deletions

### Agent Prompt Framework
- âœ… All n8n workflows migrated to use framework
- âœ… >20 prompts in library
- âœ… A/B tests showing >10% quality improvement
- âœ… <100ms prompt rendering latency
- âœ… 100% template syntax coverage

---

## ğŸ”’ Risk Mitigation

### Stability Risks
**Risk:** Nouveaux services crashent existant
**Mitigation:**
- Services isolÃ©s (ports sÃ©parÃ©s)
- Graceful degradation (AgentX fonctionne sans Benchmark)
- Feature flags pour disable si problÃ¨me

### Data Loss Risks
**Risk:** Janitor supprime fichiers importants
**Mitigation:**
- Dry-run mode par dÃ©faut
- Trash avec 30-day retention
- Transaction log pour rollback
- Approval workflow pour high-risk actions

### Performance Risks
**Risk:** Benchmark surcharge Ollama hosts
**Mitigation:**
- Rate limiting (1 test concurrent par host)
- Off-peak scheduling (4AM)
- Timeout sur tests longs (5min max)
- Circuit breaker si host down

---

## ğŸ“ MCP Google Integration (Bonus)

Pour amÃ©liorer les workflows n8n avec outils Google:

### Architecture

```
n8n Workflow
    â”‚
    â”œâ”€â†’ AgentX Prompt Service â†’ Render prompt avec context
    â”‚
    â”œâ”€â†’ MCP Google Search â†’ Fetch external data
    â”‚   â””â”€ Inject results into RAG context
    â”‚
    â”œâ”€â†’ AgentX RAG Search â†’ Get relevant docs
    â”‚
    â”œâ”€â†’ Ollama LLM â†’ Generate response
    â”‚   â””â”€ Use rendered prompt + RAG + Google data
    â”‚
    â””â”€â†’ MCP Google Calendar/Drive â†’ Store results
```

### MCP Tools Ã  IntÃ©grer

1. **Google Search MCP**
   - Query: `{{user_question}}`
   - Top 5 results â†’ RAG context
   - Use case: External knowledge enrichment

2. **Google Calendar MCP**
   - Create events from janitor reports
   - Schedule benchmark runs
   - Remind for manual approvals

3. **Google Drive MCP**
   - Store benchmark reports
   - Archive janitor findings
   - Version control for prompts (export)

### Example Workflow: Enhanced AI Query

```
N3.2: External AI Gateway (Enhanced)

1. Webhook Trigger
   â†“
2. AgentX Prompt Service
   POST /api/prompts/external_query/render
   Variables: {user, query, task_type}
   â†“
3. MCP Google Search (if task_type = research)
   Search query: {{query}}
   â†“
4. AgentX RAG Search
   POST /api/rag/search
   Query: {{query}}
   â†“
5. Combine Context
   - Rendered prompt
   - Google search results
   - RAG documents
   â†“
6. Ollama LLM
   POST /api/generate
   Context: combined
   â†“
7. MCP Google Drive (optional)
   Save response to Drive
   â†“
8. Return Response
```

---

## ğŸ“ Next Steps

1. **Review Architecture** âœ… (ce document)
2. **Prioritize Features** â†’ Discuter avec vous
3. **Create Detailed Specs** â†’ Par feature
4. **Start Sprint 1** â†’ Agent Prompt Framework
5. **Iterate** â†’ Feedback loops

---

## ğŸ¤ Questions pour Affiner

1. **PrioritÃ©s:** LLM Benchmark ou Datalake Janitor en premier?
2. **Benchmark Tests:** Quels types de tests sont les plus importants? (speed, quality, coding?)
3. **Janitor Policies:** Quels sont vos cas d'usage principaux? (duplicates, obsolete, organize?)
4. **Prompts:** Avez-vous dÃ©jÃ  des prompts n8n que vous voulez migrer?
5. **Dashboard:** PrÃ©fÃ©rence UI framework? (Alpine.js simple ou React plus riche?)
6. **MCP Google:** Quels outils Google sont prioritaires? (Search, Calendar, Drive, Sheets?)
7. **Timeline:** 11 semaines OK ou besoin plus rapide/flexible?

---

**PrÃªt Ã  dÃ©marrer?** Dis-moi tes prioritÃ©s et on crÃ©e un plan d'implÃ©mentation dÃ©taillÃ© pour le Sprint 1! ğŸš€
